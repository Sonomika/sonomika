"use strict";const p=require("fs"),l=require("path"),Ie=require("os"),De=require("crypto"),o=require("electron");var ye={},L={exports:{}};const Ce="17.2.3",Oe={version:Ce};var we;function Ae(){if(we)return L.exports;we=1;const s=p,r=l,n=Ie,t=De,i=Oe.version,d=["üîê encrypt with Dotenvx: https://dotenvx.com","üîê prevent committing .env to code: https://dotenvx.com/precommit","üîê prevent building .env in docker: https://dotenvx.com/prebuild","üì° add observability to secrets: https://dotenvx.com/ops","üë• sync secrets across teammates & machines: https://dotenvx.com/ops","üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops","‚úÖ audit secrets and track compliance: https://dotenvx.com/ops","üîÑ add secrets lifecycle management: https://dotenvx.com/ops","üîë add access controls to secrets: https://dotenvx.com/ops","üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`","‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }","‚öôÔ∏è  enable debug logging with { debug: true }","‚öôÔ∏è  override existing env vars with { override: true }","‚öôÔ∏è  suppress all logs with { quiet: true }","‚öôÔ∏è  write to custom object with { processEnv: myObject }","‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }"];function f(){return d[Math.floor(Math.random()*d.length)]}function m(a){return typeof a=="string"?!["false","0","no","off",""].includes(a.toLowerCase()):!!a}function v(){return process.stdout.isTTY}function C(a){return v()?`\x1B[2m${a}\x1B[0m`:a}const _=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function O(a){const y={};let w=a.toString();w=w.replace(/\r\n?/mg,`
`);let b;for(;(b=_.exec(w))!=null;){const D=b[1];let S=b[2]||"";S=S.trim();const h=S[0];S=S.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),h==='"'&&(S=S.replace(/\\n/g,`
`),S=S.replace(/\\r/g,"\r")),y[D]=S}return y}function T(a){a=a||{};const y=E(a);a.path=y;const w=k.configDotenv(a);if(!w.parsed){const h=new Error(`MISSING_DATA: Cannot parse ${y} for an unknown reason`);throw h.code="MISSING_DATA",h}const b=V(a).split(","),D=b.length;let S;for(let h=0;h<D;h++)try{const I=b[h].trim(),z=g(w,I);S=k.decrypt(z.ciphertext,z.key);break}catch(I){if(h+1>=D)throw I}return k.parse(S)}function A(a){console.error(`[dotenv@${i}][WARN] ${a}`)}function N(a){console.log(`[dotenv@${i}][DEBUG] ${a}`)}function q(a){console.log(`[dotenv@${i}] ${a}`)}function V(a){return a&&a.DOTENV_KEY&&a.DOTENV_KEY.length>0?a.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function g(a,y){let w;try{w=new URL(y)}catch(I){if(I.code==="ERR_INVALID_URL"){const z=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw z.code="INVALID_DOTENV_KEY",z}throw I}const b=w.password;if(!b){const I=new Error("INVALID_DOTENV_KEY: Missing key part");throw I.code="INVALID_DOTENV_KEY",I}const D=w.searchParams.get("environment");if(!D){const I=new Error("INVALID_DOTENV_KEY: Missing environment part");throw I.code="INVALID_DOTENV_KEY",I}const S=`DOTENV_VAULT_${D.toUpperCase()}`,h=a.parsed[S];if(!h){const I=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${S} in your .env.vault file.`);throw I.code="NOT_FOUND_DOTENV_ENVIRONMENT",I}return{ciphertext:h,key:b}}function E(a){let y=null;if(a&&a.path&&a.path.length>0)if(Array.isArray(a.path))for(const w of a.path)s.existsSync(w)&&(y=w.endsWith(".vault")?w:`${w}.vault`);else y=a.path.endsWith(".vault")?a.path:`${a.path}.vault`;else y=r.resolve(process.cwd(),".env.vault");return s.existsSync(y)?y:null}function x(a){return a[0]==="~"?r.join(n.homedir(),a.slice(1)):a}function M(a){const y=m(process.env.DOTENV_CONFIG_DEBUG||a&&a.debug),w=m(process.env.DOTENV_CONFIG_QUIET||a&&a.quiet);(y||!w)&&q("Loading env from encrypted .env.vault");const b=k._parseVault(a);let D=process.env;return a&&a.processEnv!=null&&(D=a.processEnv),k.populate(D,b,a),{parsed:b}}function R(a){const y=r.resolve(process.cwd(),".env");let w="utf8",b=process.env;a&&a.processEnv!=null&&(b=a.processEnv);let D=m(b.DOTENV_CONFIG_DEBUG||a&&a.debug),S=m(b.DOTENV_CONFIG_QUIET||a&&a.quiet);a&&a.encoding?w=a.encoding:D&&N("No encoding is specified. UTF-8 is used by default");let h=[y];if(a&&a.path)if(!Array.isArray(a.path))h=[x(a.path)];else{h=[];for(const $ of a.path)h.push(x($))}let I;const z={};for(const $ of h)try{const G=k.parse(s.readFileSync($,{encoding:w}));k.populate(z,G,a)}catch(G){D&&N(`Failed to load ${$} ${G.message}`),I=G}const ae=k.populate(b,z,a);if(D=m(b.DOTENV_CONFIG_DEBUG||D),S=m(b.DOTENV_CONFIG_QUIET||S),D||!S){const $=Object.keys(ae).length,G=[];for(const me of h)try{const te=r.relative(process.cwd(),me);G.push(te)}catch(te){D&&N(`Failed to load ${me} ${te.message}`),I=te}q(`injecting env (${$}) from ${G.join(",")} ${C(`-- tip: ${f()}`)}`)}return I?{parsed:z,error:I}:{parsed:z}}function B(a){if(V(a).length===0)return k.configDotenv(a);const y=E(a);return y?k._configVault(a):(A(`You set DOTENV_KEY but you are missing a .env.vault file at ${y}. Did you forget to build it?`),k.configDotenv(a))}function Q(a,y){const w=Buffer.from(y.slice(-64),"hex");let b=Buffer.from(a,"base64");const D=b.subarray(0,12),S=b.subarray(-16);b=b.subarray(12,-16);try{const h=t.createDecipheriv("aes-256-gcm",w,D);return h.setAuthTag(S),`${h.update(b)}${h.final()}`}catch(h){const I=h instanceof RangeError,z=h.message==="Invalid key length",ae=h.message==="Unsupported state or unable to authenticate data";if(I||z){const $=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw $.code="INVALID_DOTENV_KEY",$}else if(ae){const $=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw $.code="DECRYPTION_FAILED",$}else throw h}}function P(a,y,w={}){const b=!!(w&&w.debug),D=!!(w&&w.override),S={};if(typeof y!="object"){const h=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw h.code="OBJECT_REQUIRED",h}for(const h of Object.keys(y))Object.prototype.hasOwnProperty.call(a,h)?(D===!0&&(a[h]=y[h],S[h]=y[h]),b&&N(D===!0?`"${h}" is already defined and WAS overwritten`:`"${h}" is already defined and was NOT overwritten`)):(a[h]=y[h],S[h]=y[h]);return S}const k={configDotenv:R,_configVault:M,_parseVault:T,config:B,decrypt:Q,parse:O,populate:P};return L.exports.configDotenv=k.configDotenv,L.exports._configVault=k._configVault,L.exports._parseVault=k._parseVault,L.exports.config=k.config,L.exports.decrypt=k.decrypt,L.exports.parse=k.parse,L.exports.populate=k.populate,L.exports=k,L.exports}var ce,be;function Ne(){if(be)return ce;be=1;const s={};return process.env.DOTENV_CONFIG_ENCODING!=null&&(s.encoding=process.env.DOTENV_CONFIG_ENCODING),process.env.DOTENV_CONFIG_PATH!=null&&(s.path=process.env.DOTENV_CONFIG_PATH),process.env.DOTENV_CONFIG_QUIET!=null&&(s.quiet=process.env.DOTENV_CONFIG_QUIET),process.env.DOTENV_CONFIG_DEBUG!=null&&(s.debug=process.env.DOTENV_CONFIG_DEBUG),process.env.DOTENV_CONFIG_OVERRIDE!=null&&(s.override=process.env.DOTENV_CONFIG_OVERRIDE),process.env.DOTENV_CONFIG_DOTENV_KEY!=null&&(s.DOTENV_KEY=process.env.DOTENV_CONFIG_DOTENV_KEY),ce=s,ce}var le,ve;function Me(){if(ve)return le;ve=1;const s=/^dotenv_config_(encoding|path|quiet|debug|override|DOTENV_KEY)=(.+)$/;return le=function(n){const t=n.reduce(function(e,i){const d=i.match(s);return d&&(e[d[1]]=d[2]),e},{});return"quiet"in t||(t.quiet="true"),t},le}var _e;function Pe(){return _e||(_e=1,(function(){Ae().config(Object.assign({},Ne(),Me()(process.argv)))})()),ye}Pe();const H=class H{constructor(){this.sender=null,this.senderName=null,this.lastFrameAtMs=0}start(r){if(process.platform!=="win32")return{ok:!1,error:"Spout output is only supported on Windows."};const n=H.DEFAULT_SENDER_NAME;if(this.sender&&this.senderName===n)return{ok:!0};this.sender&&this.stop();const t=this.tryLoadAddon();if(!t)return{ok:!1,error:"Spout addon not found. Build/copy `electron_spout.node` and ensure it is unpacked (not inside asar)."};try{return this.sender=new t.SpoutOutput(n),this.senderName=n,this.lastFrameAtMs=0,{ok:!0}}catch(e){return this.sender=null,this.senderName=null,{ok:!1,error:`Failed to create Spout sender: ${String(e)}`}}}stop(){try{const r=this.sender;r&&typeof r.close=="function"&&r.close(),r&&typeof r.release=="function"&&r.release(),r&&typeof r.dispose=="function"&&r.dispose()}catch{}this.sender=null,this.senderName=null}isRunning(){return!!this.sender}pushDataUrlFrame(r,n){const t=this.sender;if(!t)return;const e=H.DEFAULT_MAX_FPS,i=Date.now(),d=1e3/e;if(!(i-this.lastFrameAtMs<d))try{const f=o.nativeImage.createFromDataURL(String(r||""));if(f.isEmpty())return;t.updateFrame(Buffer.from(f.toBitmap()),f.getSize()),this.lastFrameAtMs=i}catch{}}tryLoadAddon(){const r=[()=>require("electron_spout.node"),()=>require("electron-spout.node"),()=>require(l.join(process.cwd(),"electron_spout.node")),()=>require(l.join(process.cwd(),"electron-spout.node")),()=>require(l.join(process.cwd(),"native","electron_spout.node")),()=>require(l.join(process.cwd(),"native","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","native","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","native","electron-spout.node"))];for(const n of r)try{const t=n();if(t&&t.SpoutOutput)return t}catch{}return null}};H.DEFAULT_SENDER_NAME="Sonomika Output",H.DEFAULT_MAX_FPS=60;let ue=H;function pe(s){try{if(!p.existsSync(s))return null;const r=p.readFileSync(s,"utf8");return JSON.parse(r)}catch{return null}}function fe(s,r){try{const n=l.dirname(s);p.existsSync(n)||p.mkdirSync(n,{recursive:!0}),p.writeFileSync(s,JSON.stringify(r),"utf8")}catch{}}function Fe(){return l.join(o.app.getPath("userData"),"ga4_client_id.json")}function Te(){return l.join(o.app.getPath("userData"),"ga4_session.json")}function ke(){return l.join(o.app.getPath("userData"),"ga4_geo.json")}function he(s){const r=s.trim();if(!r)return!1;const n=/^\d{1,3}(\.\d{1,3}){3}$/.test(r),t=/^[0-9a-f:]+$/i.test(r)&&r.includes(":");return n||t}function je(s){try{const r=ke(),n=pe(r);if(!n||typeof n.fetched_at_ms!="number"||Date.now()-n.fetched_at_ms>s||typeof n.ip_override!="string")return;const t=n.ip_override.trim();return he(t)?t:void 0}catch{return}}async function Ve(s){try{const r=new AbortController,n=setTimeout(()=>r.abort(),Math.max(250,s));try{const t=await fetch("https://api.ipify.org?format=json",{signal:r.signal});if(!t.ok)return;const e=await t.json(),i=typeof e?.ip=="string"?e.ip.trim():"";return he(i)?(fe(ke(),{ip_override:i,fetched_at_ms:Date.now()}),i):void 0}finally{clearTimeout(n)}}catch{return}}function Re(){const s=Fe(),r=pe(s);if(r&&typeof r.client_id=="string"&&r.client_id.length>0&&typeof r.created_at_ms=="number")return{state:r,isNew:!1};const n={client_id:De.randomUUID(),created_at_ms:Date.now()};return fe(s,n),{state:n,isNew:!0}}function ze(){const s=Te(),r=pe(s),n=r&&typeof r.ga_session_number=="number"&&isFinite(r.ga_session_number)?r.ga_session_number:0,t={ga_session_number:Math.max(0,Math.floor(n))+1};return fe(s,t),{ga_session_id:Math.floor(Date.now()/1e3),ga_session_number:t.ga_session_number}}function $e(s,r){return s.length<=r?s:s.slice(0,Math.max(0,r-1))+"‚Ä¶"}function Be(s){const r=String(s.measurementId).trim(),n=String(s.apiSecret||"").trim(),t=String(s.appName).trim(),e=!!s.enableInDev,i=String(process.env.GA4_DISABLED||"").toLowerCase()==="true"||String(process.env.GA4_DISABLED||"").toLowerCase()==="1",d=o.app.isPackaged||e,f=!i&&d&&r&&n,m=String(process.env.GA4_DEBUG||"").toLowerCase()==="true"||String(process.env.GA4_DEBUG||"").toLowerCase()==="1",{state:v,isNew:C}=Re(),_=ze(),O=String(process.env.GA4_COUNTRY_ID||"").trim().toUpperCase(),T=String(process.env.GA4_REGION_ID||"").trim(),A=String(process.env.GA4_CITY||"").trim(),N=O||T||A?{...A?{city:A}:{},...T?{region_id:T}:{},...O?{country_id:O}:{}}:void 0,q=String(process.env.GA4_GEO_DISABLED||"").toLowerCase()==="true"||String(process.env.GA4_GEO_DISABLED||"").toLowerCase()==="1";let V;const g=String(process.env.GA4_IP_OVERRIDE||"").trim();he(g)&&(V=g),V||(V=je(10080*60*1e3)),!V&&!q&&Ve(2e3).then(P=>{P&&(V=P)});function E(P){return{ga_session_id:_.ga_session_id,ga_session_number:_.ga_session_number,engagement_time_msec:1,app_name:t,app_version:o.app.getVersion?.()||void 0,platform:process.platform,arch:process.arch,packaged:o.app.isPackaged,...P}}async function x(P,k){if(!f)return;const a=String(P||"").trim();if(!a)return;const w=`${m?"https://www.google-analytics.com/debug/mp/collect":"https://www.google-analytics.com/mp/collect"}?measurement_id=${encodeURIComponent(r)}&api_secret=${encodeURIComponent(n)}`,b={client_id:v.client_id,...q?{}:N?{user_location:N}:V?{ip_override:V}:{},user_properties:{app_name:{value:t},app_version:{value:o.app.getVersion?.()||"unknown"},platform:{value:process.platform},arch:{value:process.arch},packaged:{value:o.app.isPackaged?"1":"0"}},events:[{name:a,params:E(k)}]};try{const D=await fetch(w,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(b)});try{m&&await D.text()}catch{}}catch{}}function M(P,k){x(P,k)}function R(){f&&C&&M("first_open",{first_open_ms:v.created_at_ms})}function B(){f&&(M("session_start",{ts_ms:Date.now()}),M("app_open",{ts_ms:Date.now()}))}function Q(P){f&&M("app_error",{error_type:$e(String(P||"unknown"),80),fatal:!0,ts_ms:Date.now()})}return{enabled:f,clientId:v.client_id,sessionId:_.ga_session_id,sessionNumber:_.ga_session_number,track:M,trackFirstOpenOnce:R,trackAppOpen:B,trackAppError:Q}}const Le=process.env.VJ_DEBUG_LOGS!=="true",Ue=console.log,qe=console.warn;if(Le){const s=()=>{};console.log=(...r)=>{const n=r.join(" ");(n.includes("ICON")||n.includes("APP PATHS")||n.includes("RESOLVED")||n.includes("NO ICON")||n.includes("process.cwd")||n.includes("__dirname")||n.includes("Checking icon")||n.includes("‚úì")||n.includes("‚úó")||n.includes("Creating window")||n.includes("Icon loaded")||n.includes("user model")||n.includes("taskbar"))&&Ue(...r)},console.warn=(...r)=>{const n=r.join(" ");(n.includes("ICON")||n.includes("APP PATHS"))&&qe(...r)},console.info=s}process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";const Ge=o.app.requestSingleInstanceLock();Ge?o.app.on("second-instance",()=>{try{j?.track("second_instance",{ts_ms:Date.now()})}catch{}const s=o.BrowserWindow.getAllWindows();s.length>0&&(s[0].isMinimized()&&s[0].restore(),s[0].focus())}):(console.log("Another instance is already running, quitting..."),o.app.quit());let c=null,u=null,X=null,ee=null,Z=null,W=null;const U=new Map;let F={};const J=new ue,Se="Sonomika Output",We=60;let j=null,ne=null,oe=Date.now(),K=null,se=0,de=Date.now();function ge(s){if(K!=null){const r=Math.max(0,s-K);return se+=r,K=s,r}return 0}function ie(){console.log("=== ICON RESOLUTION DEBUG ==="),console.log("process.cwd():",process.cwd()),console.log("__dirname:",__dirname),console.log("process.resourcesPath:",process.resourcesPath),console.log("app.getAppPath():",o.app.getAppPath()),console.log("app.getPath(exe):",o.app.getPath("exe"));const s=[...process.platform==="win32"?[l.join(process.resourcesPath||"","icons","icon.ico"),l.join(__dirname,"../icons/icon.ico"),l.join(__dirname,"../../public/icons/icon.ico"),l.join(__dirname,"../public/icons/icon.ico"),l.join(process.cwd(),"public","icons","icon.ico"),l.join(process.resourcesPath||"","icons","sonomika_icon_2.ico"),l.join(__dirname,"../icons/sonomika_icon_2.ico")]:[],l.join(process.resourcesPath||"","icons","icon.png"),l.join(__dirname,"../icons/icon.png"),l.join(__dirname,"../../public/icons/icon.png"),l.join(__dirname,"../public/icons/icon.png"),l.join(process.cwd(),"public","icons","icon.png"),l.join(process.resourcesPath||"","icons","sonomika_icon_2.png"),l.join(__dirname,"../icons/sonomika_icon_2.png")];console.log("Checking icon candidates:");for(const r of s){const n=p.existsSync(r);if(console.log(`  ${n?"‚úì":"‚úó"} ${r}`),n){try{const t=p.statSync(r);console.log(`    Size: ${t.size} bytes, Modified: ${t.mtime}`)}catch{console.log("    (Could not stat file)")}return console.log("=== RESOLVED ICON PATH ==="),r}}console.log("=== NO ICON FOUND ===")}function xe(){const s=o.app.getPath("userData");return l.join(s,"auth_store.json")}function Ke(){try{const s=xe();if(p.existsSync(s)){const r=p.readFileSync(s,"utf8"),n=JSON.parse(r);F=Object.fromEntries(Object.entries(n).map(([t,e])=>[t,Buffer.from(e,"base64")]))}}catch(s){console.warn("Failed to load encrypted auth store, starting empty:",s),F={}}}function Y(){try{const s=xe(),r=l.dirname(s);p.existsSync(r)||p.mkdirSync(r,{recursive:!0});const n=Object.fromEntries(Object.entries(F).map(([t,e])=>[t,e.toString("base64")]));p.writeFileSync(s,JSON.stringify(n),"utf8")}catch(s){console.warn("Failed to persist encrypted auth store:",s)}}function Ye(){try{const s=o.app.getPath("documents"),r=l.join(s,"Sonomika");p.existsSync(r)||(p.mkdirSync(r,{recursive:!0}),console.log("Created Sonomika folder in Documents:",r));const n=["bank","music","recordings","video","ai-templates"];for(const g of n){const E=l.join(r,g);p.existsSync(E)||(p.mkdirSync(E,{recursive:!0}),console.log("Created folder:",E))}const t=[l.join(process.resourcesPath||"","app.asar.unpacked","bank"),l.join(__dirname,"../bank"),l.join(process.cwd(),"bank")],e=l.join(r,"bank");let i=!1;for(const g of t)if(p.existsSync(g)&&!i)try{re(g,e),console.log("Copied bank folder from",g,"to",e),i=!0}catch(E){console.warn("Failed to copy bank folder from",g,":",E)}const d=[l.join(process.resourcesPath||"","user-documents","sets"),l.join(process.resourcesPath||"","app.asar.unpacked","user-documents","sets"),l.join(__dirname,"../user-documents","sets"),l.join(process.cwd(),"user-documents","sets"),l.join(process.resourcesPath||"","app.asar.unpacked","sets"),l.join(__dirname,"../sets"),l.join(process.cwd(),"sets")],f=l.join(r,"sets");let m=!1;console.log("Looking for sets folder in source paths..."),console.log("process.resourcesPath:",process.resourcesPath);for(const g of d){const E=p.existsSync(g);if(console.log("  Checking:",g,E?"‚úì EXISTS":"‚úó NOT FOUND"),E)try{const x=p.existsSync(f)?p.readdirSync(f).length:0;re(g,f);const M=p.existsSync(f)?p.readdirSync(f).length:0;console.log(`Copied sets folder from ${g} to ${f} (${M-x} files)`),m=!0;break}catch(x){console.warn("Failed to copy sets folder from",g,":",x)}}m||console.warn("‚ö†Ô∏è Sets folder was not copied. Checked paths:",d);const v=[l.join(process.resourcesPath||"","user-documents"),l.join(process.resourcesPath||"","app.asar.unpacked","user-documents"),l.join(__dirname,"../user-documents"),l.join(process.cwd(),"user-documents")];console.log("Looking for user-documents folder in source paths...");let C=!1;for(const g of v){const E=p.existsSync(g);if(console.log("  Checking:",g,E?"‚úì EXISTS":"‚úó NOT FOUND"),E)try{const x=["midi mapping","music","recordings","video"];for(const M of x){const R=l.join(g,M),B=l.join(r,M);if(p.existsSync(R)){const Q=p.existsSync(B)?p.readdirSync(B).length:0;re(R,B);const P=p.existsSync(B)?p.readdirSync(B).length:0;console.log(`Copied ${M} folder from ${R} to ${B} (${P-Q} files)`)}else console.log(`  Source ${M} folder does not exist:`,R)}C=!0;break}catch(x){console.warn("Failed to copy user-documents folders from",g,":",x)}}C||console.warn("‚ö†Ô∏è user-documents folders were not copied. Checked paths:",v);const _=l.join(r,"ai-templates");p.existsSync(_)||p.mkdirSync(_,{recursive:!0});const O=o.app.getAppPath(),T=[l.join(process.resourcesPath||"","src","ai-templates"),l.join(process.resourcesPath||"","app.asar.unpacked","src","ai-templates"),l.join(__dirname,"../src/ai-templates"),l.join(__dirname,"../../src/ai-templates"),l.join(O,"src/ai-templates"),l.join(process.cwd(),"src/ai-templates")];let A=0;const q=(p.existsSync(_)?p.readdirSync(_).filter(g=>g.endsWith(".js")):[]).length===0;q&&console.log("AI templates folder is empty, will copy template files...");for(const g of T)if(p.existsSync(g))try{console.log("Checking AI templates source path:",g);const E=p.readdirSync(g,{withFileTypes:!0});console.log(`Found ${E.length} entries in ${g}`);for(const x of E)if(x.isFile()&&x.name.endsWith(".js")){const M=l.join(g,x.name),R=l.join(_,x.name);!p.existsSync(R)||q?(p.copyFileSync(M,R),console.log("Copied AI template file:",x.name,"to",R),A++):console.log("Skipped AI template file (already exists):",x.name)}if(A>0){console.log(`Successfully copied ${A} AI template file(s) from ${g}`);break}}catch(E){console.warn("Failed to copy AI templates from",g,":",E)}else console.log("AI templates source path does not exist:",g);A===0&&(console.warn("‚ö†Ô∏è No AI template files were copied. Checked paths:",T),console.warn("   This might indicate the template files are not included in the build."));const V=["midi mapping","sets"];for(const g of V){const E=l.join(r,g);if(p.existsSync(E)){const x=p.readdirSync(E);x.length===0?console.warn(`‚ö†Ô∏è ${g} folder exists but is empty. Files may not have been copied from installer.`):console.log(`‚úì ${g} folder has ${x.length} file(s)`)}else console.warn(`‚ö†Ô∏è ${g} folder was not created. Files may not have been found in installer.`)}}catch(s){console.error("Failed to initialize user Documents folders:",s)}}function re(s,r){p.existsSync(r)||p.mkdirSync(r,{recursive:!0});const n=p.readdirSync(s,{withFileTypes:!0});for(const t of n){const e=l.join(s,t.name),i=l.join(r,t.name);t.isDirectory()?re(e,i):p.existsSync(i)||p.copyFileSync(e,i)}}function Ee(){const s=ie();console.log("Creating window with icon path:",s);let r;if(s)try{r=o.nativeImage.createFromPath(s),r&&!r.isEmpty()?console.log("Icon loaded successfully, size:",r.getSize()):console.warn("Icon file found but failed to load or is empty")}catch(e){console.error("Error loading icon:",e)}c=new o.BrowserWindow({width:1200,height:800,frame:!1,titleBarStyle:"hidden",icon:r,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:l.join(__dirname,"preload.js"),backgroundThrottling:!1},show:!1});try{c.on("focus",()=>{const e=Date.now();K=e,j?.track("app_focus",{ts_ms:e})}),c.on("blur",()=>{const e=Date.now(),i=ge(e);K=null,j?.track("app_blur",{ts_ms:e,active_delta_ms:i,active_total_ms:se})})}catch{}const n=l.join(__dirname,"preload.js");if(console.log("Preload script path:",n),console.log("Preload script exists:",require("fs").existsSync(n)),require("fs").existsSync(n)){const e=require("fs").readFileSync(n,"utf8");console.log("Preload script first 200 chars:",e.substring(0,200))}c.webContents.session.webRequest.onHeadersReceived((e,i)=>{console.log("Setting CSP headers for URL:",e.url);const d={...e.responseHeaders,"Content-Security-Policy":[]};console.log("CSP headers disabled for development"),i({responseHeaders:d})}),c.once("ready-to-show",()=>{if(c.show(),c.webContents.setBackgroundThrottling(!1),process.platform==="win32"&&r)try{c.setIcon(r),console.log("Forced icon update on window after show")}catch(e){console.error("Error forcing icon update:",e)}}),setTimeout(()=>{try{c&&!c.isDestroyed()&&!c.isVisible()&&c.show()}catch{}},2e3);try{c.webContents.setWindowOpenHandler(e=>{if(e.frameName==="output-canvas")return{action:"allow",overrideBrowserWindowOptions:{title:"Output",frame:!1,titleBarStyle:"hidden",autoHideMenuBar:!0,backgroundColor:"#000000",fullscreenable:!0,resizable:!0,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,backgroundThrottling:!1}}};const d=e.url;return d&&(d.startsWith("http://")||d.startsWith("https://"))?(o.shell.openExternal(d),{action:"deny"}):{action:"allow"}}),c.webContents.on("did-create-window",(e,i)=>{try{if(i?.frameName==="output-canvas"){ee=e;try{e.removeMenu()}catch{}try{e.setMenuBarVisibility(!1)}catch{}try{e.webContents.setBackgroundThrottling(!1)}catch{}try{Z&&isFinite(Z)&&Z>0&&e.setAspectRatio(Z)}catch{}try{e.on("closed",()=>{ee=null})}catch{}}}catch{}})}catch{}if(c.on("maximize",()=>{try{c?.webContents.send("window-state",{maximized:!0})}catch{}}),c.on("unmaximize",()=>{try{c?.webContents.send("window-state",{maximized:!1})}catch{}}),process.env.NODE_ENV==="development"||!o.app.isPackaged){console.log("Running in development mode");const e=process.env.VITE_DEV_SERVER_URL||process.env.ELECTRON_RENDERER_URL,i=Number(process.env.VITE_DEV_SERVER_PORT||5173),d=[],f=v=>{v&&(d.includes(v)||d.push(v))};f(e),f(`http://localhost:${i}`),f(`http://127.0.0.1:${i}`);const m=(v,C=0)=>{if(!c)return;if(v.length===0){console.warn("All dev server attempts failed; showing inline error page");const A=d.filter(Boolean),N=`<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: http: https:; script-src 'unsafe-inline' data: http: https:; style-src 'unsafe-inline' data: http: https:;" />
    <title>Dev Server Not Available</title>
    <style>
      body { font-family: sans-serif; background: #141414; color: #aaaaaa; padding: 32px; }
      pre { background:#1f1f1f; padding:16px; border-radius:8px; overflow:auto; }
      .muted { color: #aaaaaa; }
      button { background:#1f1f1f; color:#aaaaaa; border: 1px solid #262626; padding: 10px 12px; border-radius: 8px; cursor: pointer; }
      button:hover { background:#262626; }
      code { color: #aaaaaa; }
    </style>
  </head>
  <body>
    <h1>Dev Server Not Available</h1>
    <p>Could not connect to the Vite dev server on port ${i}.</p>
    <p class="muted">This window will keep retrying automatically.</p>
    <p>Make sure it is running with:</p>
    <pre>cd "${process.cwd()}"
npm run dev:electron</pre>
    <div style="margin-top: 16px;">
      <button id="retryBtn" type="button">Retry now</button>
      <span id="status" class="muted" style="margin-left: 12px;"></span>
    </div>
    <script>
      (function () {
        const candidates = ${JSON.stringify(A)};
        const statusEl = document.getElementById('status');
        const setStatus = (t) => { try { statusEl.textContent = t; } catch {} };

        async function tryLoad() {
          for (const url of candidates) {
            try {
              setStatus('Trying ' + url + ' ...');
              // Use no-cors HEAD/GET fallback; we only care if it responds at all
              const res = await fetch(url, { method: 'GET', cache: 'no-store' });
              if (res && (res.ok || res.status === 304)) {
                setStatus('Connected. Loading...');
                window.location.href = url;
                return;
              }
            } catch (e) {
              // ignore and continue
            }
          }
          setStatus('Still waiting for dev server...');
        }

        document.getElementById('retryBtn')?.addEventListener('click', () => { tryLoad(); });
        // Initial + periodic retries
        tryLoad();
        setInterval(tryLoad, 1500);
      })();
    <\/script>
  </body>
</html>`;c.loadURL(`data:text/html,${encodeURIComponent(N)}`);return}const _=v[0],O=v.slice(1),T=C+1;console.log(`Trying dev server URL: ${_} (attempt ${T})`),c.loadURL(_).then(()=>{console.log(`Electron loaded renderer from ${_}`),c?.webContents.openDevTools({mode:"detach"})}).catch(A=>{console.warn(`Failed to load ${_}: ${A?.message||A}`);const N=Math.min(5e3,1e3*Math.pow(2,C));console.log(`Retrying with next candidate in ${N}ms`),setTimeout(()=>m(O,T),N)})};setTimeout(()=>m(d),1200)}else{console.log("Running in production mode");const e=o.app.getAppPath(),i=[l.join(e,"dist/index.html"),l.join(__dirname,"../dist/index.html"),l.join(__dirname,"../web/index.html")],d=i.find(f=>{try{return p.existsSync(f)}catch{return!1}});d?(console.log("Loading production file:",d),c.loadFile(d)):(console.error("No production index.html found at",i),console.error("App path:",e),console.error("__dirname:",__dirname),c.loadURL("data:text/html,<html><body><h1>VJ App</h1><p>Missing build.</p></body></html>"))}c.webContents.on("did-finish-load",()=>{console.log("Window loaded successfully")});try{c.webContents.on("render-process-gone",(e,i)=>{console.error("[electron] render-process-gone",i)}),c.webContents.on("unresponsive",()=>{console.error("[electron] webContents became unresponsive")}),c.webContents.on("media-started-playing",()=>{console.log("[electron] media-started-playing")}),c.webContents.on("media-paused",()=>{console.log("[electron] media-paused")})}catch{}c.webContents.on("did-fail-load",(e,i,d)=>{console.error("Failed to load:",i,d)}),c.on("closed",()=>{c=null})}function Je(){if(u&&!u.isDestroyed()){u.focus();return}const s=ie();console.log("Creating mirror window with icon path:",s);let r;if(s)try{r=o.nativeImage.createFromPath(s),r&&!r.isEmpty()?console.log("Mirror window icon loaded successfully, size:",r.getSize()):console.warn("Mirror window icon file found but failed to load or is empty")}catch(t){console.error("Error loading mirror window icon:",t)}u=new o.BrowserWindow({width:1920,height:1080,title:"sonomika",icon:r,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:l.join(__dirname,"mirror-preload.js"),backgroundThrottling:!1},show:!1,resizable:!0,maximizable:!0,fullscreen:!1,kiosk:!1,alwaysOnTop:!0,skipTaskbar:!1,focusable:!0,movable:!0,frame:!1,titleBarStyle:"hidden",transparent:!1,fullscreenable:!0,autoHideMenuBar:!0,minWidth:480,minHeight:270}),u.loadURL(`data:text/html,${encodeURIComponent(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>sonomika</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          background: #000;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          overflow: hidden;
          font-family: monospace;
        }
        /* Make the background draggable */
        body::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          -webkit-app-region: drag;
          z-index: 0;
        }
        img {
          width: 100%;
          height: 100%;
          object-fit: contain; /* Changed from cover to contain to show full canvas */
          image-rendering: -webkit-optimize-contrast;
          image-rendering: crisp-edges;
          image-rendering: pixelated; /* Prefer crisp scaling */
          transition: opacity 0.1s ease-in-out;
          -webkit-app-region: drag; /* Make image draggable */
          position: relative;
          z-index: 1;
        }
        
        /* When in fullscreen, use contain to avoid letterboxing */
        body:fullscreen img,
        body:-webkit-full-screen img {
          object-fit: contain;
        }
        .no-stream {
          color: #fff;
          text-align: center;
          font-size: 14px;
          -webkit-app-region: no-drag; /* Don't drag when clicking text */
          position: relative;
          z-index: 1;
        }
        #mirror-image {
          opacity: 0;
          transition: opacity 0.2s ease-in-out;
        }
        #mirror-image.loaded {
          opacity: 1;
        }
        /* Custom resize handles */
        .resize-handle {
          position: absolute;
          background: transparent;
          z-index: 1000;
          -webkit-app-region: no-drag; /* Prevent dragging on resize handles */
        }
        .resize-handle.nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nw-resize; }
        .resize-handle.ne { top: 0; right: 0; width: 10px; height: 10px; cursor: ne-resize; }
        .resize-handle.sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: sw-resize; }
        .resize-handle.se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: se-resize; }
        .resize-handle.n { top: 0; left: 10px; right: 10px; height: 10px; cursor: n-resize; }
        .resize-handle.s { bottom: 0; left: 10px; right: 10px; height: 10px; cursor: s-resize; }
        .resize-handle.w { left: 0; top: 10px; bottom: 10px; width: 10px; cursor: w-resize; }
        .resize-handle.e { right: 0; top: 10px; bottom: 10px; width: 10px; cursor: e-resize; }
      </style>
    </head>
    <body ondblclick="toggleFullscreen()">
      <div id="no-stream" class="no-stream">Waiting for stream...</div>
      <img id="mirror-image" style="display: none;" onload="this.classList.add('loaded');" onclick="handleImageClick(event)" ondblclick="handleImageDoubleClick(event)">
      
      <!-- Resize handles -->
      <div class="resize-handle nw"></div>
      <div class="resize-handle ne"></div>
      <div class="resize-handle sw"></div>
      <div class="resize-handle se"></div>
      <div class="resize-handle n"></div>
      <div class="resize-handle s"></div>
      <div class="resize-handle w"></div>
      <div class="resize-handle e"></div>
      
      <script>
        let isFullSize = false;
        
        function toggleFullscreen() {
          // Send message to main process to toggle fullscreen
          if (window.mirrorAPI && window.mirrorAPI.toggleFullscreen) {
            window.mirrorAPI.toggleFullscreen();
          }
        }
        
        function handleImageClick(event) {
          // Prevent dragging when clicking on the image
          event.stopPropagation();
        }
        
        function handleImageDoubleClick(event) {
          // Prevent dragging when double-clicking on the image
          event.stopPropagation();
          
          // Toggle between canvas size and full size
          if (window.mirrorAPI && window.mirrorAPI.resizeMirrorWindow) {
            if (isFullSize) {
              // Switch back to canvas size (will be sent by renderer)
              // For now, use a reasonable default that will be updated
              window.mirrorAPI.resizeMirrorWindow(1920, 1080);
              isFullSize = false;
            } else {
              // Switch to full size
              window.mirrorAPI.resizeMirrorWindow(1920, 1080);
              isFullSize = true;
            }
          }
        }
      <\/script>
    </body>
    </html>
  `)}`),u.once("ready-to-show",()=>{u.show(),u.center();try{u.setAspectRatio(W||1920/1080)}catch{}try{X==null&&(X=o.powerSaveBlocker.start("prevent-display-sleep")),u.webContents.setBackgroundThrottling(!1)}catch{}}),u.webContents.on("before-input-event",(t,e)=>{e.key==="Escape"&&u.close()}),u.on("closed",()=>{try{X!=null&&o.powerSaveBlocker.stop(X)}catch{}X=null,console.log("Mirror window closed, notifying main app"),c&&!c.isDestroyed()&&c.webContents.send("mirror-window-closed"),u=null})}function He(){u&&!u.isDestroyed()&&(u.close(),u=null)}function Qe(s,r){const n=U.get(s);if(n&&!n.isDestroyed()){try{n.focus()}catch{}return n}const t=l.join(__dirname,"mirror-preload.js"),e=l.join(__dirname,"preload.js"),i=p.existsSync(t)?t:e,d=ie(),f=d?o.nativeImage.createFromPath(d):void 0,m=new o.BrowserWindow({width:r?.width??960,height:r?.height??540,x:r?.x,y:r?.y,title:r?.title??`VJ Mirror Slice: ${s}`,icon:f,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:i},show:!1,resizable:!0,maximizable:!0,fullscreen:!1,kiosk:!1,alwaysOnTop:!0,skipTaskbar:!1,focusable:!0,movable:!0,frame:!1,titleBarStyle:"hidden",transparent:!1,thickFrame:!1,hasShadow:!1,backgroundColor:"#000000",fullscreenable:!0,autoHideMenuBar:!0,minWidth:320,minHeight:180});try{m.setMenuBarVisibility(!1)}catch{}try{m.removeMenu()}catch{}const v=`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${r?.title??`VJ Mirror Slice: ${s}`}</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          background: #000;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          overflow: hidden;
          font-family: monospace;
        }
        /* Make the background draggable */
        body::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          -webkit-app-region: drag;
          z-index: 0;
        }
        img { width: 100%; height: 100%; object-fit: cover; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; transition: opacity 0.1s ease-in-out; -webkit-app-region: drag; position: relative; z-index: 1; }
        #mirror-image { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #mirror-image.loaded { opacity: 1; }
      </style>
    </head>
    <body ondblclick="toggleFullscreen()">
      <img id="mirror-image" style="display: none;" onload="this.classList.add('loaded');">
      <script>
        function toggleFullscreen() {
          try { window.advancedMirror && window.advancedMirror.toggleSliceFullscreen && window.advancedMirror.toggleSliceFullscreen('${s}'); } catch {}
        }
      <\/script>
    </body>
    </html>
  `;m.loadURL(`data:text/html,${encodeURIComponent(v)}`);try{m.show(),m.center()}catch{}return m.once("ready-to-show",()=>{try{m.isVisible()||(m.show(),m.center())}catch{}}),m.on("closed",()=>{U.delete(s)}),m.webContents.on("before-input-event",(C,_)=>{_.key==="Escape"&&m.close()}),U.set(s,m),m}function Xe(){const s=[{label:"VJ App",submenu:[{label:"About VJ App",role:"about"},{type:"separator"},{label:"Quit",accelerator:"CmdOrCtrl+Q",click:()=>{o.app.quit()}}]},{label:"External",submenu:[{label:"Mirror Window",accelerator:"CmdOrCtrl+M",click:()=>{c&&c.webContents.send("toggle-mirror")}},{label:"Advanced Mirror",accelerator:"CmdOrCtrl+Shift+M",click:()=>{c&&c.webContents.send("toggle-advanced-mirror")}},{type:"separator"},{label:"Spout Output",click:()=>{try{c?.webContents.send("spout:toggle")}catch{}}}]},{label:"Record",submenu:[{label:"Record",accelerator:"CmdOrCtrl+Shift+R",click:()=>{c&&c.webContents.send("record:start")}},{label:"Record Settings",click:()=>{c&&c.webContents.send("record:settings")}}]},{label:"View",submenu:[{label:"Toggle Mirror Window",accelerator:"CmdOrCtrl+M",click:()=>{c&&c.webContents.send("toggle-mirror")}},{type:"separator"},{label:"Reload",accelerator:"CmdOrCtrl+R",click:()=>{c&&c.reload()}}]},{label:"Developer",submenu:[{label:"Toggle Debug Overlay",accelerator:"CmdOrCtrl+Shift+D",click:()=>{try{c?.webContents.send("debug:toggleOverlay")}catch{}}},{label:"Show Debug Panel",accelerator:"CmdOrCtrl+Alt+D",click:()=>{try{c?.webContents.send("debug:openPanel")}catch{}}},{type:"separator"},{label:"Toggle Developer Tools",accelerator:"F12",click:()=>{c&&c.webContents.toggleDevTools()}}]},{label:"Window",submenu:[{label:"Minimize",accelerator:"CmdOrCtrl+M",role:"minimize"},{label:"Close",accelerator:"CmdOrCtrl+W",role:"close"}]}],r=o.Menu.buildFromTemplate(s);o.Menu.setApplicationMenu(r)}o.app.whenReady().then(()=>{console.log("Electron app is ready"),console.log("=== APP PATHS DEBUG ==="),console.log("app.getAppPath():",o.app.getPath("appData")),console.log("app.getPath(exe):",o.app.getPath("exe")),console.log("process.execPath:",process.execPath),console.log("process.resourcesPath:",process.resourcesPath);try{j=Be({measurementId:process.env.GA4_MEASUREMENT_ID||"G-6F2FP4ZXNS",apiSecret:process.env.GA4_API_SECRET,appName:"Sonomika",enableInDev:String(process.env.GA4_ENABLE_DEV||"").toLowerCase()==="true"}),oe=Date.now(),de=oe,j.trackFirstOpenOnce(),j.trackAppOpen(),K=Date.now();const n=j;n&&n.enabled&&(ne=setInterval(()=>{try{const t=Date.now(),e=Math.max(0,t-de);de=t;const i=ge(t);n.track("user_engagement",{ts_ms:t,uptime_ms:Math.max(0,t-oe),heartbeat_interval_ms:e,engagement_time_msec:Math.max(0,i),active_total_ms:se})}catch{}},6e4))}catch{}if(process.platform==="win32")try{o.app.setAppUserModelId("com.sonomika.app"),console.log("Set app user model ID for Windows taskbar icon")}catch(n){console.error("Error setting app user model ID:",n)}try{o.app.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required")}catch{}try{const n=ie();console.log("Icon path resolved at app.whenReady():",n),process.platform==="darwin"&&n&&o.app.dock&&typeof o.app.dock.setIcon=="function"&&o.app.dock.setIcon(o.nativeImage.createFromPath(n))}catch(n){console.error("Error setting dock icon:",n)}o.app.commandLine.appendSwitch("disable-background-timer-throttling"),o.app.commandLine.appendSwitch("disable-renderer-backgrounding"),o.app.commandLine.appendSwitch("disable-backgrounding-occluded-windows");try{const n=o.app.commandLine.getSwitchValue("disable-features"),t="CalculateNativeWinOcclusion";n&&n.length>0?n.split(",").includes(t)||o.app.commandLine.appendSwitch("disable-features",`${n},${t}`):o.app.commandLine.appendSwitch("disable-features",t)}catch{}Xe(),Ke(),Ye(),o.protocol.registerFileProtocol("local-file",(n,t)=>{const e=n.url.replace("local-file://","");console.log("Loading local file:",e),console.log("Request URL:",n.url),console.log("File path resolved:",e),t(e)}),o.ipcMain.on("ga4:track",(n,t)=>{try{if(!j?.enabled)return;const e=String(t?.name||"").trim();if(!e)return;const i=e.slice(0,40).replace(/[^a-zA-Z0-9_]/g,"_"),d=t?.params&&typeof t.params=="object"?t.params:{},f={};for(const[m,v]of Object.entries(d)){const C=String(m||"").trim().slice(0,40).replace(/[^a-zA-Z0-9_]/g,"_");if(!C||v==null)continue;const _=typeof v;if(_==="string"){const O=String(v);f[C]=O.length>120?O.slice(0,120):O}else if(_==="number"){const O=Number(v);isFinite(O)&&(f[C]=O)}else _==="boolean"&&(f[C]=!!v)}j.track(i,f)}catch{}}),o.ipcMain.handle("show-open-dialog",async(n,t)=>await o.dialog.showOpenDialog(c,t)),o.ipcMain.handle("show-save-dialog",async(n,t)=>{console.log("Show save dialog called with options:",t);const e=await o.dialog.showSaveDialog(c,t);return console.log("Save dialog result:",e),e}),o.ipcMain.handle("save-file",async(n,t,e)=>{try{return await p.promises.writeFile(t,e,"utf8"),!0}catch(i){return console.error("Failed to save file:",i),!1}}),o.ipcMain.handle("save-binary-file",async(n,t,e)=>{try{return console.log("Saving binary file to:",t,"Size:",e.length,"bytes"),await p.promises.writeFile(t,Buffer.from(e)),console.log("Binary file saved successfully"),!0}catch(i){return console.error("Failed to save binary file:",i),!1}});let s=null,r=null;o.ipcMain.handle("offline-render:start",async(n,t)=>{try{const e=l.join(o.app.getPath("userData"),"offline-renders"),i=l.join(e,`${Date.now()}_${(t?.name||"movie").replace(/[^a-z0-9_-]/ig,"_")}`);return await p.promises.mkdir(i,{recursive:!0}),s={dir:i,name:String(t?.name||"movie"),fps:Number(t?.fps)||0,index:0,width:Number(t?.width)||1920,height:Number(t?.height)||1080,quality:t?.quality||"medium"},r=null,console.log("[offline] start",{dir:i,fps:s.fps||"preview",quality:s.quality,size:`${s.width}x${s.height}`}),{success:!0,dir:i}}catch(e){return console.error("[offline] start error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("offline-render:frame",async(n,t)=>{if(!s)return{success:!1,error:"No session"};try{const e=s,i=l.join(e.dir,`frame_${String(e.index).padStart(6,"0")}.png`),d=String(t?.dataUrl||"").replace(/^data:image\/png;base64,/,"");return await p.promises.writeFile(i,Buffer.from(d,"base64")),e.index+=1,e.index%60===0&&console.log("[offline] saved frames:",e.index),{success:!0,index:e.index}}catch(e){return console.error("[offline] frame error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("offline-render:finish",async(n,t)=>{if(!s)return{success:!1,error:"No session"};s=null;try{return{success:!1,error:"Offline rendering is disabled. Please use WebM recording via MediaRecorder instead."}}catch(e){return console.error("[offline] finish error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("get-system-audio-stream",async()=>{try{const{desktopCapturer:n}=require("electron"),t=await n.getSources({types:["screen"],thumbnailSize:{width:1,height:1}});if(t.length===0)throw new Error("No screen sources available");return{success:!0,sourceId:(t.find(i=>i.name==="Entire Screen")||t[0]).id}}catch(n){return console.error("Failed to get system audio stream:",n),{success:!1,error:String(n)}}}),o.ipcMain.handle("get-documents-folder",async()=>{try{const n=o.app.getPath("documents");return{success:!0,path:l.join(n,"Sonomika")}}catch(n){return console.error("Failed to get Documents folder:",n),{success:!1,error:String(n)}}}),o.ipcMain.handle("get-app-path",async()=>o.app.getAppPath()),o.ipcMain.handle("open-external-url",async(n,t)=>{try{return t&&typeof t=="string"&&(t.startsWith("http://")||t.startsWith("https://"))?(await o.shell.openExternal(t),{success:!0}):{success:!1,error:"Invalid URL"}}catch(e){return console.error("open-external-url failed:",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("get-app-version",async()=>{try{const n=e=>{try{if(!e||!p.existsSync(e))return"";const i=p.readFileSync(e,"utf8"),f=JSON.parse(i)?.version;return typeof f=="string"?f.trim():""}catch{return""}},t=[l.join(o.app.getAppPath(),"package.json"),l.join(process.cwd(),"package.json"),l.resolve(__dirname,"..","..","package.json"),l.resolve(__dirname,"..","package.json")];for(const e of t){const i=n(e);if(i)return i}return o.app.getVersion()}catch(n){return console.error("Failed to get app version:",n),"unknown"}}),o.ipcMain.handle("get-resources-path",async()=>process.resourcesPath||o.app.getAppPath()),o.ipcMain.handle("spout:start",async(n,t)=>{try{const e=J.start(Se);return e.ok===!1?(console.warn("[spout] start failed:",e.error),{success:!1,error:e.error}):(console.log("[spout] started sender:",Se),{success:!0})}catch(e){return console.warn("[spout] start exception:",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("spout:stop",async()=>{try{J.stop();try{setTimeout(()=>{try{J.stop()}catch{}},200)}catch{}return console.log("[spout] stopped"),{success:!0}}catch(n){return console.warn("[spout] stop exception:",n),{success:!1,error:String(n)}}}),o.ipcMain.on("spout:frame",(n,t)=>{try{if(!J.isRunning())return;J.pushDataUrlFrame(String(t?.dataUrl||""),{maxFps:We})}catch{}}),o.ipcMain.handle("read-file-text",async(n,t)=>{try{return await p.promises.readFile(t,"utf8")}catch(e){return console.error("Failed to read file:",e),null}}),o.ipcMain.handle("read-local-file-base64",async(n,t)=>{try{return(await p.promises.readFile(t)).toString("base64")}catch(e){throw console.error("Failed to read local file:",t,e),e}}),o.ipcMain.handle("read-audio-bytes",async(n,t)=>{try{const{fileURLToPath:e}=require("url"),i=typeof t=="string"&&t.startsWith("file:")?e(t):t,d=await p.promises.readFile(i);return d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength)}catch(e){return console.error("read-audio-bytes failed for",t,e),new ArrayBuffer(0)}}),o.ipcMain.handle("authStorage:isEncryptionAvailable",()=>{try{return o.safeStorage.isEncryptionAvailable()}catch{return!1}}),o.ipcMain.on("authStorage:isEncryptionAvailableSync",n=>{try{n.returnValue=o.safeStorage.isEncryptionAvailable()}catch{n.returnValue=!1}}),o.ipcMain.handle("authStorage:save",async(n,t,e)=>{try{return t?e==null||e===""?(delete F[t],Y(),!0):(o.safeStorage.isEncryptionAvailable()?F[t]=o.safeStorage.encryptString(e):F[t]=Buffer.from(e,"utf8"),Y(),!0):!1}catch(i){return console.error("Failed to save auth blob:",i),!1}}),o.ipcMain.on("authStorage:saveSync",(n,t,e)=>{try{if(!t){n.returnValue=!1;return}if(e==null||e===""){delete F[t],Y(),n.returnValue=!0;return}o.safeStorage.isEncryptionAvailable()?F[t]=o.safeStorage.encryptString(e):F[t]=Buffer.from(e,"utf8"),Y(),n.returnValue=!0}catch(i){console.error("Failed to save auth blob (sync):",i),n.returnValue=!1}}),o.ipcMain.handle("authStorage:load",async(n,t)=>{try{if(!t)return null;const e=F[t];return e?o.safeStorage.isEncryptionAvailable()?o.safeStorage.decryptString(e):e.toString("utf8"):null}catch(e){return console.error("Failed to load auth blob:",e),null}}),o.ipcMain.on("authStorage:loadSync",(n,t)=>{try{if(!t){n.returnValue=null;return}const e=F[t];if(!e){n.returnValue=null;return}o.safeStorage.isEncryptionAvailable()?n.returnValue=o.safeStorage.decryptString(e):n.returnValue=e.toString("utf8")}catch(e){console.error("Failed to load auth blob (sync):",e),n.returnValue=null}}),o.ipcMain.handle("authStorage:remove",async(n,t)=>{try{return t?(delete F[t],Y(),!0):!1}catch(e){return console.error("Failed to remove auth blob:",e),!1}}),o.ipcMain.on("authStorage:removeSync",(n,t)=>{try{if(!t){n.returnValue=!1;return}delete F[t],Y(),n.returnValue=!0}catch(e){console.error("Failed to remove auth blob (sync):",e),n.returnValue=!1}}),o.ipcMain.handle("authStorage:loadAll",async()=>{try{const n={};for(const[t,e]of Object.entries(F))try{o.safeStorage.isEncryptionAvailable()?n[t]=o.safeStorage.decryptString(e):n[t]=e.toString("utf8")}catch{}return n}catch(n){return console.error("Failed to loadAll auth blobs:",n),{}}}),o.ipcMain.handle("get-screen-sizes",async()=>{try{const{screen:n}=require("electron"),t=n.getAllDisplays();console.log("Electron main: Detected displays:",t.length),t.forEach((i,d)=>{console.log(`Display ${d+1}:`,{width:i.bounds.width,height:i.bounds.height,x:i.bounds.x,y:i.bounds.y,scaleFactor:i.scaleFactor,rotation:i.rotation,label:i.label})});const e=t.map(i=>({width:i.bounds.width,height:i.bounds.height}));return console.log("Electron main: Returning screen sizes:",e),e}catch(n){return console.error("Failed to get screen sizes:",n),[]}}),o.ipcMain.on("toggle-app-fullscreen",()=>{if(c&&!c.isDestroyed()){const{screen:n}=require("electron");if(c.isKiosk()||c.isFullScreen())c.setKiosk(!1),c.setFullScreen(!1),c.setBounds({width:1200,height:800}),c.center();else{const t=c.getBounds(),e=n.getDisplayMatching(t);c.setBounds({x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height}),c.setMenuBarVisibility(!1),c.setFullScreenable(!0),c.setAlwaysOnTop(!0),c.setKiosk(!0),c.setFullScreen(!0)}}}),o.ipcMain.on("window-minimize",()=>{console.log("Main: window-minimize IPC received"),c?(console.log("Main: calling mainWindow.minimize()"),c.minimize()):console.log("Main: mainWindow is null")}),o.ipcMain.on("window-maximize",()=>{if(console.log("Main: window-maximize IPC received"),c)if(c.isMaximized()){console.log("Main: calling mainWindow.unmaximize()"),c.unmaximize();try{c.webContents.send("window-state",{maximized:!1})}catch{}}else{console.log("Main: calling mainWindow.maximize()"),c.maximize();try{c.webContents.send("window-state",{maximized:!0})}catch{}}else console.log("Main: mainWindow is null")}),o.ipcMain.on("window-close",()=>{console.log("Main: window-close IPC received"),c?(console.log("Main: calling mainWindow.close()"),c.close()):console.log("Main: mainWindow is null")}),o.ipcMain.on("toggle-mirror",()=>{c&&c.webContents.send("toggle-mirror")}),o.ipcMain.on("open-mirror-window",()=>{Je()}),o.ipcMain.on("close-mirror-window",()=>{He()}),o.ipcMain.on("set-mirror-bg",(n,t)=>{if(u&&!u.isDestroyed()){const e=typeof t=="string"?t.replace(/'/g,"\\'"):"#000000";u.webContents.executeJavaScript(`document.body.style.background='${e}'`)}}),o.ipcMain.on("canvas-data",(n,t)=>{u&&!u.isDestroyed()&&u.webContents.send("update-canvas",t)}),o.ipcMain.on("sendCanvasData",(n,t)=>{if(u&&!u.isDestroyed())try{const e=(typeof t=="string"?t:"").replace(/'/g,"\\'");u.webContents.executeJavaScript(`
          (function(){
            try {
              var noStream = document.getElementById('no-stream');
              var img = document.getElementById('mirror-image');
              if (noStream) noStream.style.display = 'none';
              if (img) {
                if (img.src !== '${e}') {
                  img.src = '${e}';
                  img.style.display = 'block';
                }
              }
            } catch(e) {}
          })();
        `)}catch{}}),o.ipcMain.on("toggle-fullscreen",()=>{if(u&&!u.isDestroyed()){const{screen:n}=require("electron");if(u.isKiosk()||u.isFullScreen()){u.setKiosk(!1),u.setFullScreen(!1);try{u.setVisibleOnAllWorkspaces(!1)}catch{}try{u.setAlwaysOnTop(!0)}catch{}u.setBounds({x:void 0,y:void 0,width:1920,height:1080});try{u.center()}catch{}try{u.focus()}catch{}}else{const t=u.getBounds(),e=n.getDisplayMatching(t);u.setBounds({x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height});try{u.setMenuBarVisibility(!1)}catch{}try{u.setFullScreenable(!0)}catch{}try{process.platform==="darwin"?u.setAlwaysOnTop(!0,"screen-saver"):u.setAlwaysOnTop(!0)}catch{}try{u.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}try{u.moveTop?.()}catch{}try{u.show()}catch{}try{u.focus()}catch{}u.setKiosk(!0),u.setFullScreen(!0);try{u.moveTop?.()}catch{}try{u.focus()}catch{}}}}),o.ipcMain.on("resize-mirror-window",(n,t,e)=>{if(u&&!u.isDestroyed()){try{let i=Math.max(1,Number(t)||1),d=Math.max(1,Number(e)||1);const{screen:f}=require("electron"),v=f.getPrimaryDisplay().workArea,C=Math.floor(v.width*.9),_=Math.floor(v.height*.9),O=i/d;if(i>C||d>_){const T=C/i,A=_/d,N=Math.min(T,A);i=Math.floor(i*N),d=Math.floor(d*N)}i=Math.max(480,i),d=Math.max(270,d),W&&isFinite(W)&&W>0&&(d=Math.max(1,Math.round(i/W))),console.log("Resizing mirror window to:",i,"x",d,"(aspect locked:",!!W,")"),u.setSize(i,d)}catch{}u.center()}}),o.ipcMain.on("set-mirror-aspect",(n,t,e)=>{try{const i=Math.max(1,Number(t)||1),d=Math.max(1,Number(e)||1),f=i/d;if(W=f,Z=f,u&&!u.isDestroyed())try{u.setAspectRatio(f)}catch{}if(ee&&!ee.isDestroyed())try{ee.setAspectRatio(f)}catch{}}catch{}}),o.ipcMain.on("advanced-mirror:open",(n,t)=>{try{if(console.log("[main] advanced-mirror:open",Array.isArray(t)?t.map(e=>e?.id):t),Array.isArray(t))for(const e of t)console.log("[main] createAdvancedMirrorWindow",e?.id),Qe(String(e.id),e)}catch(e){console.warn("advanced-mirror:open error",e)}}),o.ipcMain.on("advanced-mirror:closeAll",()=>{try{U.forEach((n,t)=>{try{n.isDestroyed()||n.close()}catch{}U.delete(t)})}catch(n){console.warn("advanced-mirror:closeAll error",n)}}),o.ipcMain.on("advanced-mirror:sendSliceData",(n,t,e)=>{const i=U.get(String(t));if(i&&!i.isDestroyed()){const d=(typeof e=="string"?e:"").replace(/'/g,"\\'");i.webContents.executeJavaScript(`
        (function() {
          const mirrorImage = document.getElementById('mirror-image');
          if (mirrorImage) {
            if (mirrorImage.src !== '${d}') {
              mirrorImage.src = '${d}';
              mirrorImage.style.display = 'block';
            }
          }
        })();
      `)}}),o.ipcMain.on("advanced-mirror:setBg",(n,t,e)=>{const i=U.get(String(t));if(i&&!i.isDestroyed()){const d=typeof e=="string"?e.replace(/'/g,"\\'"):"#000000";i.webContents.executeJavaScript(`document.body.style.background='${d}'`)}}),o.ipcMain.on("advanced-mirror:resize",(n,t,e,i)=>{const d=U.get(String(t));if(d&&!d.isDestroyed())try{d.setSize(e,i),d.center()}catch{}}),o.ipcMain.on("advanced-mirror:toggleFullscreen",(n,t)=>{const e=U.get(String(t));if(e&&!e.isDestroyed()){const{screen:i}=require("electron");if(e.isKiosk()||e.isFullScreen())try{e.setKiosk(!1),e.setFullScreen(!1),e.setBounds({width:960,height:540}),e.center()}catch{}else try{const d=e.getBounds(),f=i.getDisplayMatching(d);e.setBounds({x:f.bounds.x,y:f.bounds.y,width:f.bounds.width,height:f.bounds.height}),e.setMenuBarVisibility(!1),e.setFullScreenable(!0),e.setAlwaysOnTop(!0),e.setKiosk(!0),e.setFullScreen(!0)}catch{}}}),Ee(),o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&Ee()})});try{o.app.on("before-quit",()=>{try{const s=Date.now(),r=ge(s);K=null;try{ne&&clearInterval(ne)}catch{}ne=null,j?.track("session_end",{ts_ms:s,uptime_ms:Math.max(0,s-oe),active_delta_ms:r,active_total_ms:se}),j?.track("app_quit",{ts_ms:s})}catch{}try{J.stop()}catch{}})}catch{}o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&o.app.quit()});process.on("uncaughtException",s=>{console.error("Uncaught Exception:",s);try{j?.trackAppError(s?.name||"uncaughtException")}catch{}});process.on("unhandledRejection",(s,r)=>{console.error("Unhandled Rejection at:",r,"reason:",s);try{j?.trackAppError("unhandledRejection")}catch{}});
