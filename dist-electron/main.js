"use strict";const p=require("fs"),l=require("path"),De=require("os"),_e=require("crypto"),o=require("electron");var he={},$={exports:{}};const xe="17.2.3",Ce={version:xe};var ge;function Ie(){if(ge)return $.exports;ge=1;const s=p,r=l,n=De,t=_e,i=Ce.version,d=["üîê encrypt with Dotenvx: https://dotenvx.com","üîê prevent committing .env to code: https://dotenvx.com/precommit","üîê prevent building .env in docker: https://dotenvx.com/prebuild","üì° add observability to secrets: https://dotenvx.com/ops","üë• sync secrets across teammates & machines: https://dotenvx.com/ops","üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops","‚úÖ audit secrets and track compliance: https://dotenvx.com/ops","üîÑ add secrets lifecycle management: https://dotenvx.com/ops","üîë add access controls to secrets: https://dotenvx.com/ops","üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`","‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }","‚öôÔ∏è  enable debug logging with { debug: true }","‚öôÔ∏è  override existing env vars with { override: true }","‚öôÔ∏è  suppress all logs with { quiet: true }","‚öôÔ∏è  write to custom object with { processEnv: myObject }","‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }"];function f(){return d[Math.floor(Math.random()*d.length)]}function m(a){return typeof a=="string"?!["false","0","no","off",""].includes(a.toLowerCase()):!!a}function w(){return process.stdout.isTTY}function O(a){return w()?`\x1B[2m${a}\x1B[0m`:a}const _=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function N(a){const y={};let b=a.toString();b=b.replace(/\r\n?/mg,`
`);let v;for(;(v=_.exec(b))!=null;){const D=v[1];let E=v[2]||"";E=E.trim();const g=E[0];E=E.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),g==='"'&&(E=E.replace(/\\n/g,`
`),E=E.replace(/\\r/g,"\r")),y[D]=E}return y}function V(a){a=a||{};const y=S(a);a.path=y;const b=I.configDotenv(a);if(!b.parsed){const g=new Error(`MISSING_DATA: Cannot parse ${y} for an unknown reason`);throw g.code="MISSING_DATA",g}const v=G(a).split(","),D=v.length;let E;for(let g=0;g<D;g++)try{const x=v[g].trim(),T=h(b,x);E=I.decrypt(T.ciphertext,T.key);break}catch(x){if(g+1>=D)throw x}return I.parse(E)}function C(a){console.error(`[dotenv@${i}][WARN] ${a}`)}function M(a){console.log(`[dotenv@${i}][DEBUG] ${a}`)}function L(a){console.log(`[dotenv@${i}] ${a}`)}function G(a){return a&&a.DOTENV_KEY&&a.DOTENV_KEY.length>0?a.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function h(a,y){let b;try{b=new URL(y)}catch(x){if(x.code==="ERR_INVALID_URL"){const T=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw T.code="INVALID_DOTENV_KEY",T}throw x}const v=b.password;if(!v){const x=new Error("INVALID_DOTENV_KEY: Missing key part");throw x.code="INVALID_DOTENV_KEY",x}const D=b.searchParams.get("environment");if(!D){const x=new Error("INVALID_DOTENV_KEY: Missing environment part");throw x.code="INVALID_DOTENV_KEY",x}const E=`DOTENV_VAULT_${D.toUpperCase()}`,g=a.parsed[E];if(!g){const x=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${E} in your .env.vault file.`);throw x.code="NOT_FOUND_DOTENV_ENVIRONMENT",x}return{ciphertext:g,key:v}}function S(a){let y=null;if(a&&a.path&&a.path.length>0)if(Array.isArray(a.path))for(const b of a.path)s.existsSync(b)&&(y=b.endsWith(".vault")?b:`${b}.vault`);else y=a.path.endsWith(".vault")?a.path:`${a.path}.vault`;else y=r.resolve(process.cwd(),".env.vault");return s.existsSync(y)?y:null}function k(a){return a[0]==="~"?r.join(n.homedir(),a.slice(1)):a}function R(a){const y=m(process.env.DOTENV_CONFIG_DEBUG||a&&a.debug),b=m(process.env.DOTENV_CONFIG_QUIET||a&&a.quiet);(y||!b)&&L("Loading env from encrypted .env.vault");const v=I._parseVault(a);let D=process.env;return a&&a.processEnv!=null&&(D=a.processEnv),I.populate(D,v,a),{parsed:v}}function F(a){const y=r.resolve(process.cwd(),".env");let b="utf8",v=process.env;a&&a.processEnv!=null&&(v=a.processEnv);let D=m(v.DOTENV_CONFIG_DEBUG||a&&a.debug),E=m(v.DOTENV_CONFIG_QUIET||a&&a.quiet);a&&a.encoding?b=a.encoding:D&&M("No encoding is specified. UTF-8 is used by default");let g=[y];if(a&&a.path)if(!Array.isArray(a.path))g=[k(a.path)];else{g=[];for(const j of a.path)g.push(k(j))}let x;const T={};for(const j of g)try{const U=I.parse(s.readFileSync(j,{encoding:b}));I.populate(T,U,a)}catch(U){D&&M(`Failed to load ${j} ${U.message}`),x=U}const ae=I.populate(v,T,a);if(D=m(v.DOTENV_CONFIG_DEBUG||D),E=m(v.DOTENV_CONFIG_QUIET||E),D||!E){const j=Object.keys(ae).length,U=[];for(const fe of g)try{const ee=r.relative(process.cwd(),fe);U.push(ee)}catch(ee){D&&M(`Failed to load ${fe} ${ee.message}`),x=ee}L(`injecting env (${j}) from ${U.join(",")} ${O(`-- tip: ${f()}`)}`)}return x?{parsed:T,error:x}:{parsed:T}}function z(a){if(G(a).length===0)return I.configDotenv(a);const y=S(a);return y?I._configVault(a):(C(`You set DOTENV_KEY but you are missing a .env.vault file at ${y}. Did you forget to build it?`),I.configDotenv(a))}function H(a,y){const b=Buffer.from(y.slice(-64),"hex");let v=Buffer.from(a,"base64");const D=v.subarray(0,12),E=v.subarray(-16);v=v.subarray(12,-16);try{const g=t.createDecipheriv("aes-256-gcm",b,D);return g.setAuthTag(E),`${g.update(v)}${g.final()}`}catch(g){const x=g instanceof RangeError,T=g.message==="Invalid key length",ae=g.message==="Unsupported state or unable to authenticate data";if(x||T){const j=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw j.code="INVALID_DOTENV_KEY",j}else if(ae){const j=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw j.code="DECRYPTION_FAILED",j}else throw g}}function ie(a,y,b={}){const v=!!(b&&b.debug),D=!!(b&&b.override),E={};if(typeof y!="object"){const g=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw g.code="OBJECT_REQUIRED",g}for(const g of Object.keys(y))Object.prototype.hasOwnProperty.call(a,g)?(D===!0&&(a[g]=y[g],E[g]=y[g]),v&&M(D===!0?`"${g}" is already defined and WAS overwritten`:`"${g}" is already defined and was NOT overwritten`)):(a[g]=y[g],E[g]=y[g]);return E}const I={configDotenv:F,_configVault:R,_parseVault:V,config:z,decrypt:H,parse:N,populate:ie};return $.exports.configDotenv=I.configDotenv,$.exports._configVault=I._configVault,$.exports._parseVault=I._parseVault,$.exports.config=I.config,$.exports.decrypt=I.decrypt,$.exports.parse=I.parse,$.exports.populate=I.populate,$.exports=I,$.exports}var ce,me;function Oe(){if(me)return ce;me=1;const s={};return process.env.DOTENV_CONFIG_ENCODING!=null&&(s.encoding=process.env.DOTENV_CONFIG_ENCODING),process.env.DOTENV_CONFIG_PATH!=null&&(s.path=process.env.DOTENV_CONFIG_PATH),process.env.DOTENV_CONFIG_QUIET!=null&&(s.quiet=process.env.DOTENV_CONFIG_QUIET),process.env.DOTENV_CONFIG_DEBUG!=null&&(s.debug=process.env.DOTENV_CONFIG_DEBUG),process.env.DOTENV_CONFIG_OVERRIDE!=null&&(s.override=process.env.DOTENV_CONFIG_OVERRIDE),process.env.DOTENV_CONFIG_DOTENV_KEY!=null&&(s.DOTENV_KEY=process.env.DOTENV_CONFIG_DOTENV_KEY),ce=s,ce}var le,ye;function Me(){if(ye)return le;ye=1;const s=/^dotenv_config_(encoding|path|quiet|debug|override|DOTENV_KEY)=(.+)$/;return le=function(n){const t=n.reduce(function(e,i){const d=i.match(s);return d&&(e[d[1]]=d[2]),e},{});return"quiet"in t||(t.quiet="true"),t},le}var we;function Ne(){return we||(we=1,(function(){Ie().config(Object.assign({},Oe(),Me()(process.argv)))})()),he}Ne();const J=class J{constructor(){this.sender=null,this.senderName=null,this.lastFrameAtMs=0}start(r){if(process.platform!=="win32")return{ok:!1,error:"Spout output is only supported on Windows."};const n=J.DEFAULT_SENDER_NAME;if(this.sender&&this.senderName===n)return{ok:!0};this.sender&&this.stop();const t=this.tryLoadAddon();if(!t)return{ok:!1,error:"Spout addon not found. Build/copy `electron_spout.node` and ensure it is unpacked (not inside asar)."};try{return this.sender=new t.SpoutOutput(n),this.senderName=n,this.lastFrameAtMs=0,{ok:!0}}catch(e){return this.sender=null,this.senderName=null,{ok:!1,error:`Failed to create Spout sender: ${String(e)}`}}}stop(){try{const r=this.sender;r&&typeof r.close=="function"&&r.close(),r&&typeof r.release=="function"&&r.release(),r&&typeof r.dispose=="function"&&r.dispose()}catch{}this.sender=null,this.senderName=null}isRunning(){return!!this.sender}pushDataUrlFrame(r,n){const t=this.sender;if(!t)return;const e=J.DEFAULT_MAX_FPS,i=Date.now(),d=1e3/e;if(!(i-this.lastFrameAtMs<d))try{const f=o.nativeImage.createFromDataURL(String(r||""));if(f.isEmpty())return;t.updateFrame(Buffer.from(f.toBitmap()),f.getSize()),this.lastFrameAtMs=i}catch{}}tryLoadAddon(){const r=[()=>require("electron_spout.node"),()=>require("electron-spout.node"),()=>require(l.join(process.cwd(),"electron_spout.node")),()=>require(l.join(process.cwd(),"electron-spout.node")),()=>require(l.join(process.cwd(),"native","electron_spout.node")),()=>require(l.join(process.cwd(),"native","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","electron-spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","native","electron_spout.node")),()=>require(l.join(process.resourcesPath||"","app.asar.unpacked","native","electron-spout.node"))];for(const n of r)try{const t=n();if(t&&t.SpoutOutput)return t}catch{}return null}};J.DEFAULT_SENDER_NAME="Sonomika Output",J.DEFAULT_MAX_FPS=60;let ue=J;function Se(s){try{if(!p.existsSync(s))return null;const r=p.readFileSync(s,"utf8");return JSON.parse(r)}catch{return null}}function Ee(s,r){try{const n=l.dirname(s);p.existsSync(n)||p.mkdirSync(n,{recursive:!0}),p.writeFileSync(s,JSON.stringify(r),"utf8")}catch{}}function Ae(){return l.join(o.app.getPath("userData"),"ga4_client_id.json")}function Pe(){return l.join(o.app.getPath("userData"),"ga4_session.json")}function Fe(){const s=Ae(),r=Se(s);if(r&&typeof r.client_id=="string"&&r.client_id.length>0&&typeof r.created_at_ms=="number")return{state:r,isNew:!1};const n={client_id:_e.randomUUID(),created_at_ms:Date.now()};return Ee(s,n),{state:n,isNew:!0}}function Te(){const s=Pe(),r=Se(s),n=r&&typeof r.ga_session_number=="number"&&isFinite(r.ga_session_number)?r.ga_session_number:0,t={ga_session_number:Math.max(0,Math.floor(n))+1};return Ee(s,t),{ga_session_id:Math.floor(Date.now()/1e3),ga_session_number:t.ga_session_number}}function je(s,r){return s.length<=r?s:s.slice(0,Math.max(0,r-1))+"‚Ä¶"}function Ve(s){const r=String(s.measurementId).trim(),n=String(s.apiSecret||"").trim(),t=String(s.appName).trim(),e=!!s.enableInDev,i=String(process.env.GA4_DISABLED||"").toLowerCase()==="true"||String(process.env.GA4_DISABLED||"").toLowerCase()==="1",d=o.app.isPackaged||e,f=!i&&d&&r&&n,m=String(process.env.GA4_DEBUG||"").toLowerCase()==="true"||String(process.env.GA4_DEBUG||"").toLowerCase()==="1",{state:w,isNew:O}=Fe(),_=Te();function N(h){return{ga_session_id:_.ga_session_id,ga_session_number:_.ga_session_number,engagement_time_msec:1,app_name:t,app_version:o.app.getVersion?.()||void 0,platform:process.platform,arch:process.arch,packaged:o.app.isPackaged,...h}}async function V(h,S){if(!f)return;const k=String(h||"").trim();if(!k)return;const F=`${m?"https://www.google-analytics.com/debug/mp/collect":"https://www.google-analytics.com/mp/collect"}?measurement_id=${encodeURIComponent(r)}&api_secret=${encodeURIComponent(n)}`,z={client_id:w.client_id,user_properties:{app_name:{value:t},app_version:{value:o.app.getVersion?.()||"unknown"},platform:{value:process.platform},arch:{value:process.arch},packaged:{value:o.app.isPackaged?"1":"0"}},events:[{name:k,params:N(S)}]};try{const H=await fetch(F,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(z)});try{m&&await H.text()}catch{}}catch{}}function C(h,S){V(h,S)}function M(){f&&O&&C("first_open",{first_open_ms:w.created_at_ms})}function L(){f&&(C("session_start",{ts_ms:Date.now()}),C("app_open",{ts_ms:Date.now()}))}function G(h){f&&C("app_error",{error_type:je(String(h||"unknown"),80),fatal:!0,ts_ms:Date.now()})}return{enabled:f,clientId:w.client_id,sessionId:_.ga_session_id,sessionNumber:_.ga_session_number,track:C,trackFirstOpenOnce:M,trackAppOpen:L,trackAppError:G}}const Re=process.env.VJ_DEBUG_LOGS!=="true",ze=console.log,$e=console.warn;if(Re){const s=()=>{};console.log=(...r)=>{const n=r.join(" ");(n.includes("ICON")||n.includes("APP PATHS")||n.includes("RESOLVED")||n.includes("NO ICON")||n.includes("process.cwd")||n.includes("__dirname")||n.includes("Checking icon")||n.includes("‚úì")||n.includes("‚úó")||n.includes("Creating window")||n.includes("Icon loaded")||n.includes("user model")||n.includes("taskbar"))&&ze(...r)},console.warn=(...r)=>{const n=r.join(" ");(n.includes("ICON")||n.includes("APP PATHS"))&&$e(...r)},console.info=s}process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";const Be=o.app.requestSingleInstanceLock();Be?o.app.on("second-instance",()=>{try{P?.track("second_instance",{ts_ms:Date.now()})}catch{}const s=o.BrowserWindow.getAllWindows();s.length>0&&(s[0].isMinimized()&&s[0].restore(),s[0].focus())}):(console.log("Another instance is already running, quitting..."),o.app.quit());let c=null,u=null,Q=null,Z=null,X=null,q=null;const B=new Map;let A={};const Y=new ue,be="Sonomika Output",Le=60;let P=null,te=null,ne=Date.now(),W=null,re=0,de=Date.now();function pe(s){if(W!=null){const r=Math.max(0,s-W);return re+=r,W=s,r}return 0}function se(){console.log("=== ICON RESOLUTION DEBUG ==="),console.log("process.cwd():",process.cwd()),console.log("__dirname:",__dirname),console.log("process.resourcesPath:",process.resourcesPath),console.log("app.getAppPath():",o.app.getAppPath()),console.log("app.getPath(exe):",o.app.getPath("exe"));const s=[...process.platform==="win32"?[l.join(process.resourcesPath||"","icons","icon.ico"),l.join(__dirname,"../icons/icon.ico"),l.join(__dirname,"../../public/icons/icon.ico"),l.join(__dirname,"../public/icons/icon.ico"),l.join(process.cwd(),"public","icons","icon.ico"),l.join(process.resourcesPath||"","icons","sonomika_icon_2.ico"),l.join(__dirname,"../icons/sonomika_icon_2.ico")]:[],l.join(process.resourcesPath||"","icons","icon.png"),l.join(__dirname,"../icons/icon.png"),l.join(__dirname,"../../public/icons/icon.png"),l.join(__dirname,"../public/icons/icon.png"),l.join(process.cwd(),"public","icons","icon.png"),l.join(process.resourcesPath||"","icons","sonomika_icon_2.png"),l.join(__dirname,"../icons/sonomika_icon_2.png")];console.log("Checking icon candidates:");for(const r of s){const n=p.existsSync(r);if(console.log(`  ${n?"‚úì":"‚úó"} ${r}`),n){try{const t=p.statSync(r);console.log(`    Size: ${t.size} bytes, Modified: ${t.mtime}`)}catch{console.log("    (Could not stat file)")}return console.log("=== RESOLVED ICON PATH ==="),r}}console.log("=== NO ICON FOUND ===")}function ke(){const s=o.app.getPath("userData");return l.join(s,"auth_store.json")}function Ue(){try{const s=ke();if(p.existsSync(s)){const r=p.readFileSync(s,"utf8"),n=JSON.parse(r);A=Object.fromEntries(Object.entries(n).map(([t,e])=>[t,Buffer.from(e,"base64")]))}}catch(s){console.warn("Failed to load encrypted auth store, starting empty:",s),A={}}}function K(){try{const s=ke(),r=l.dirname(s);p.existsSync(r)||p.mkdirSync(r,{recursive:!0});const n=Object.fromEntries(Object.entries(A).map(([t,e])=>[t,e.toString("base64")]));p.writeFileSync(s,JSON.stringify(n),"utf8")}catch(s){console.warn("Failed to persist encrypted auth store:",s)}}function qe(){try{const s=o.app.getPath("documents"),r=l.join(s,"Sonomika");p.existsSync(r)||(p.mkdirSync(r,{recursive:!0}),console.log("Created Sonomika folder in Documents:",r));const n=["bank","music","recordings","video","ai-templates"];for(const h of n){const S=l.join(r,h);p.existsSync(S)||(p.mkdirSync(S,{recursive:!0}),console.log("Created folder:",S))}const t=[l.join(process.resourcesPath||"","app.asar.unpacked","bank"),l.join(__dirname,"../bank"),l.join(process.cwd(),"bank")],e=l.join(r,"bank");let i=!1;for(const h of t)if(p.existsSync(h)&&!i)try{oe(h,e),console.log("Copied bank folder from",h,"to",e),i=!0}catch(S){console.warn("Failed to copy bank folder from",h,":",S)}const d=[l.join(process.resourcesPath||"","user-documents","sets"),l.join(process.resourcesPath||"","app.asar.unpacked","user-documents","sets"),l.join(__dirname,"../user-documents","sets"),l.join(process.cwd(),"user-documents","sets"),l.join(process.resourcesPath||"","app.asar.unpacked","sets"),l.join(__dirname,"../sets"),l.join(process.cwd(),"sets")],f=l.join(r,"sets");let m=!1;console.log("Looking for sets folder in source paths..."),console.log("process.resourcesPath:",process.resourcesPath);for(const h of d){const S=p.existsSync(h);if(console.log("  Checking:",h,S?"‚úì EXISTS":"‚úó NOT FOUND"),S)try{const k=p.existsSync(f)?p.readdirSync(f).length:0;oe(h,f);const R=p.existsSync(f)?p.readdirSync(f).length:0;console.log(`Copied sets folder from ${h} to ${f} (${R-k} files)`),m=!0;break}catch(k){console.warn("Failed to copy sets folder from",h,":",k)}}m||console.warn("‚ö†Ô∏è Sets folder was not copied. Checked paths:",d);const w=[l.join(process.resourcesPath||"","user-documents"),l.join(process.resourcesPath||"","app.asar.unpacked","user-documents"),l.join(__dirname,"../user-documents"),l.join(process.cwd(),"user-documents")];console.log("Looking for user-documents folder in source paths...");let O=!1;for(const h of w){const S=p.existsSync(h);if(console.log("  Checking:",h,S?"‚úì EXISTS":"‚úó NOT FOUND"),S)try{const k=["midi mapping","music","recordings","video"];for(const R of k){const F=l.join(h,R),z=l.join(r,R);if(p.existsSync(F)){const H=p.existsSync(z)?p.readdirSync(z).length:0;oe(F,z);const ie=p.existsSync(z)?p.readdirSync(z).length:0;console.log(`Copied ${R} folder from ${F} to ${z} (${ie-H} files)`)}else console.log(`  Source ${R} folder does not exist:`,F)}O=!0;break}catch(k){console.warn("Failed to copy user-documents folders from",h,":",k)}}O||console.warn("‚ö†Ô∏è user-documents folders were not copied. Checked paths:",w);const _=l.join(r,"ai-templates");p.existsSync(_)||p.mkdirSync(_,{recursive:!0});const N=o.app.getAppPath(),V=[l.join(process.resourcesPath||"","src","ai-templates"),l.join(process.resourcesPath||"","app.asar.unpacked","src","ai-templates"),l.join(__dirname,"../src/ai-templates"),l.join(__dirname,"../../src/ai-templates"),l.join(N,"src/ai-templates"),l.join(process.cwd(),"src/ai-templates")];let C=0;const L=(p.existsSync(_)?p.readdirSync(_).filter(h=>h.endsWith(".js")):[]).length===0;L&&console.log("AI templates folder is empty, will copy template files...");for(const h of V)if(p.existsSync(h))try{console.log("Checking AI templates source path:",h);const S=p.readdirSync(h,{withFileTypes:!0});console.log(`Found ${S.length} entries in ${h}`);for(const k of S)if(k.isFile()&&k.name.endsWith(".js")){const R=l.join(h,k.name),F=l.join(_,k.name);!p.existsSync(F)||L?(p.copyFileSync(R,F),console.log("Copied AI template file:",k.name,"to",F),C++):console.log("Skipped AI template file (already exists):",k.name)}if(C>0){console.log(`Successfully copied ${C} AI template file(s) from ${h}`);break}}catch(S){console.warn("Failed to copy AI templates from",h,":",S)}else console.log("AI templates source path does not exist:",h);C===0&&(console.warn("‚ö†Ô∏è No AI template files were copied. Checked paths:",V),console.warn("   This might indicate the template files are not included in the build."));const G=["midi mapping","sets"];for(const h of G){const S=l.join(r,h);if(p.existsSync(S)){const k=p.readdirSync(S);k.length===0?console.warn(`‚ö†Ô∏è ${h} folder exists but is empty. Files may not have been copied from installer.`):console.log(`‚úì ${h} folder has ${k.length} file(s)`)}else console.warn(`‚ö†Ô∏è ${h} folder was not created. Files may not have been found in installer.`)}}catch(s){console.error("Failed to initialize user Documents folders:",s)}}function oe(s,r){p.existsSync(r)||p.mkdirSync(r,{recursive:!0});const n=p.readdirSync(s,{withFileTypes:!0});for(const t of n){const e=l.join(s,t.name),i=l.join(r,t.name);t.isDirectory()?oe(e,i):p.existsSync(i)||p.copyFileSync(e,i)}}function ve(){const s=se();console.log("Creating window with icon path:",s);let r;if(s)try{r=o.nativeImage.createFromPath(s),r&&!r.isEmpty()?console.log("Icon loaded successfully, size:",r.getSize()):console.warn("Icon file found but failed to load or is empty")}catch(e){console.error("Error loading icon:",e)}c=new o.BrowserWindow({width:1200,height:800,frame:!1,titleBarStyle:"hidden",icon:r,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:l.join(__dirname,"preload.js"),backgroundThrottling:!1},show:!1});try{c.on("focus",()=>{const e=Date.now();W=e,P?.track("app_focus",{ts_ms:e})}),c.on("blur",()=>{const e=Date.now(),i=pe(e);W=null,P?.track("app_blur",{ts_ms:e,active_delta_ms:i,active_total_ms:re})})}catch{}const n=l.join(__dirname,"preload.js");if(console.log("Preload script path:",n),console.log("Preload script exists:",require("fs").existsSync(n)),require("fs").existsSync(n)){const e=require("fs").readFileSync(n,"utf8");console.log("Preload script first 200 chars:",e.substring(0,200))}c.webContents.session.webRequest.onHeadersReceived((e,i)=>{console.log("Setting CSP headers for URL:",e.url);const d={...e.responseHeaders,"Content-Security-Policy":[]};console.log("CSP headers disabled for development"),i({responseHeaders:d})}),c.once("ready-to-show",()=>{if(c.show(),c.webContents.setBackgroundThrottling(!1),process.platform==="win32"&&r)try{c.setIcon(r),console.log("Forced icon update on window after show")}catch(e){console.error("Error forcing icon update:",e)}}),setTimeout(()=>{try{c&&!c.isDestroyed()&&!c.isVisible()&&c.show()}catch{}},2e3);try{c.webContents.setWindowOpenHandler(e=>{if(e.frameName==="output-canvas")return{action:"allow",overrideBrowserWindowOptions:{title:"Output",frame:!1,titleBarStyle:"hidden",autoHideMenuBar:!0,backgroundColor:"#000000",fullscreenable:!0,resizable:!0,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,backgroundThrottling:!1}}};const d=e.url;return d&&(d.startsWith("http://")||d.startsWith("https://"))?(o.shell.openExternal(d),{action:"deny"}):{action:"allow"}}),c.webContents.on("did-create-window",(e,i)=>{try{if(i?.frameName==="output-canvas"){Z=e;try{e.removeMenu()}catch{}try{e.setMenuBarVisibility(!1)}catch{}try{e.webContents.setBackgroundThrottling(!1)}catch{}try{X&&isFinite(X)&&X>0&&e.setAspectRatio(X)}catch{}try{e.on("closed",()=>{Z=null})}catch{}}}catch{}})}catch{}if(c.on("maximize",()=>{try{c?.webContents.send("window-state",{maximized:!0})}catch{}}),c.on("unmaximize",()=>{try{c?.webContents.send("window-state",{maximized:!1})}catch{}}),process.env.NODE_ENV==="development"||!o.app.isPackaged){console.log("Running in development mode");const e=process.env.VITE_DEV_SERVER_URL||process.env.ELECTRON_RENDERER_URL,i=Number(process.env.VITE_DEV_SERVER_PORT||5173),d=[],f=w=>{w&&(d.includes(w)||d.push(w))};f(e),f(`http://localhost:${i}`),f(`http://127.0.0.1:${i}`);const m=(w,O=0)=>{if(!c)return;if(w.length===0){console.warn("All dev server attempts failed; showing inline error page");const C=d.filter(Boolean),M=`<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: http: https:; script-src 'unsafe-inline' data: http: https:; style-src 'unsafe-inline' data: http: https:;" />
    <title>Dev Server Not Available</title>
    <style>
      body { font-family: sans-serif; background: #141414; color: #aaaaaa; padding: 32px; }
      pre { background:#1f1f1f; padding:16px; border-radius:8px; overflow:auto; }
      .muted { color: #aaaaaa; }
      button { background:#1f1f1f; color:#aaaaaa; border: 1px solid #262626; padding: 10px 12px; border-radius: 8px; cursor: pointer; }
      button:hover { background:#262626; }
      code { color: #aaaaaa; }
    </style>
  </head>
  <body>
    <h1>Dev Server Not Available</h1>
    <p>Could not connect to the Vite dev server on port ${i}.</p>
    <p class="muted">This window will keep retrying automatically.</p>
    <p>Make sure it is running with:</p>
    <pre>cd "${process.cwd()}"
npm run dev:electron</pre>
    <div style="margin-top: 16px;">
      <button id="retryBtn" type="button">Retry now</button>
      <span id="status" class="muted" style="margin-left: 12px;"></span>
    </div>
    <script>
      (function () {
        const candidates = ${JSON.stringify(C)};
        const statusEl = document.getElementById('status');
        const setStatus = (t) => { try { statusEl.textContent = t; } catch {} };

        async function tryLoad() {
          for (const url of candidates) {
            try {
              setStatus('Trying ' + url + ' ...');
              // Use no-cors HEAD/GET fallback; we only care if it responds at all
              const res = await fetch(url, { method: 'GET', cache: 'no-store' });
              if (res && (res.ok || res.status === 304)) {
                setStatus('Connected. Loading...');
                window.location.href = url;
                return;
              }
            } catch (e) {
              // ignore and continue
            }
          }
          setStatus('Still waiting for dev server...');
        }

        document.getElementById('retryBtn')?.addEventListener('click', () => { tryLoad(); });
        // Initial + periodic retries
        tryLoad();
        setInterval(tryLoad, 1500);
      })();
    <\/script>
  </body>
</html>`;c.loadURL(`data:text/html,${encodeURIComponent(M)}`);return}const _=w[0],N=w.slice(1),V=O+1;console.log(`Trying dev server URL: ${_} (attempt ${V})`),c.loadURL(_).then(()=>{console.log(`Electron loaded renderer from ${_}`),c?.webContents.openDevTools({mode:"detach"})}).catch(C=>{console.warn(`Failed to load ${_}: ${C?.message||C}`);const M=Math.min(5e3,1e3*Math.pow(2,O));console.log(`Retrying with next candidate in ${M}ms`),setTimeout(()=>m(N,V),M)})};setTimeout(()=>m(d),1200)}else{console.log("Running in production mode");const e=o.app.getAppPath(),i=[l.join(e,"dist/index.html"),l.join(__dirname,"../dist/index.html"),l.join(__dirname,"../web/index.html")],d=i.find(f=>{try{return p.existsSync(f)}catch{return!1}});d?(console.log("Loading production file:",d),c.loadFile(d)):(console.error("No production index.html found at",i),console.error("App path:",e),console.error("__dirname:",__dirname),c.loadURL("data:text/html,<html><body><h1>VJ App</h1><p>Missing build.</p></body></html>"))}c.webContents.on("did-finish-load",()=>{console.log("Window loaded successfully")});try{c.webContents.on("render-process-gone",(e,i)=>{console.error("[electron] render-process-gone",i)}),c.webContents.on("unresponsive",()=>{console.error("[electron] webContents became unresponsive")}),c.webContents.on("media-started-playing",()=>{console.log("[electron] media-started-playing")}),c.webContents.on("media-paused",()=>{console.log("[electron] media-paused")})}catch{}c.webContents.on("did-fail-load",(e,i,d)=>{console.error("Failed to load:",i,d)}),c.on("closed",()=>{c=null})}function We(){if(u&&!u.isDestroyed()){u.focus();return}const s=se();console.log("Creating mirror window with icon path:",s);let r;if(s)try{r=o.nativeImage.createFromPath(s),r&&!r.isEmpty()?console.log("Mirror window icon loaded successfully, size:",r.getSize()):console.warn("Mirror window icon file found but failed to load or is empty")}catch(t){console.error("Error loading mirror window icon:",t)}u=new o.BrowserWindow({width:1920,height:1080,title:"sonomika",icon:r,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:l.join(__dirname,"mirror-preload.js"),backgroundThrottling:!1},show:!1,resizable:!0,maximizable:!0,fullscreen:!1,kiosk:!1,alwaysOnTop:!0,skipTaskbar:!1,focusable:!0,movable:!0,frame:!1,titleBarStyle:"hidden",transparent:!1,fullscreenable:!0,autoHideMenuBar:!0,minWidth:480,minHeight:270}),u.loadURL(`data:text/html,${encodeURIComponent(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>sonomika</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          background: #000;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          overflow: hidden;
          font-family: monospace;
        }
        /* Make the background draggable */
        body::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          -webkit-app-region: drag;
          z-index: 0;
        }
        img {
          width: 100%;
          height: 100%;
          object-fit: contain; /* Changed from cover to contain to show full canvas */
          image-rendering: -webkit-optimize-contrast;
          image-rendering: crisp-edges;
          image-rendering: pixelated; /* Prefer crisp scaling */
          transition: opacity 0.1s ease-in-out;
          -webkit-app-region: drag; /* Make image draggable */
          position: relative;
          z-index: 1;
        }
        
        /* When in fullscreen, use contain to avoid letterboxing */
        body:fullscreen img,
        body:-webkit-full-screen img {
          object-fit: contain;
        }
        .no-stream {
          color: #fff;
          text-align: center;
          font-size: 14px;
          -webkit-app-region: no-drag; /* Don't drag when clicking text */
          position: relative;
          z-index: 1;
        }
        #mirror-image {
          opacity: 0;
          transition: opacity 0.2s ease-in-out;
        }
        #mirror-image.loaded {
          opacity: 1;
        }
        /* Custom resize handles */
        .resize-handle {
          position: absolute;
          background: transparent;
          z-index: 1000;
          -webkit-app-region: no-drag; /* Prevent dragging on resize handles */
        }
        .resize-handle.nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nw-resize; }
        .resize-handle.ne { top: 0; right: 0; width: 10px; height: 10px; cursor: ne-resize; }
        .resize-handle.sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: sw-resize; }
        .resize-handle.se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: se-resize; }
        .resize-handle.n { top: 0; left: 10px; right: 10px; height: 10px; cursor: n-resize; }
        .resize-handle.s { bottom: 0; left: 10px; right: 10px; height: 10px; cursor: s-resize; }
        .resize-handle.w { left: 0; top: 10px; bottom: 10px; width: 10px; cursor: w-resize; }
        .resize-handle.e { right: 0; top: 10px; bottom: 10px; width: 10px; cursor: e-resize; }
      </style>
    </head>
    <body ondblclick="toggleFullscreen()">
      <div id="no-stream" class="no-stream">Waiting for stream...</div>
      <img id="mirror-image" style="display: none;" onload="this.classList.add('loaded');" onclick="handleImageClick(event)" ondblclick="handleImageDoubleClick(event)">
      
      <!-- Resize handles -->
      <div class="resize-handle nw"></div>
      <div class="resize-handle ne"></div>
      <div class="resize-handle sw"></div>
      <div class="resize-handle se"></div>
      <div class="resize-handle n"></div>
      <div class="resize-handle s"></div>
      <div class="resize-handle w"></div>
      <div class="resize-handle e"></div>
      
      <script>
        let isFullSize = false;
        
        function toggleFullscreen() {
          // Send message to main process to toggle fullscreen
          if (window.mirrorAPI && window.mirrorAPI.toggleFullscreen) {
            window.mirrorAPI.toggleFullscreen();
          }
        }
        
        function handleImageClick(event) {
          // Prevent dragging when clicking on the image
          event.stopPropagation();
        }
        
        function handleImageDoubleClick(event) {
          // Prevent dragging when double-clicking on the image
          event.stopPropagation();
          
          // Toggle between canvas size and full size
          if (window.mirrorAPI && window.mirrorAPI.resizeMirrorWindow) {
            if (isFullSize) {
              // Switch back to canvas size (will be sent by renderer)
              // For now, use a reasonable default that will be updated
              window.mirrorAPI.resizeMirrorWindow(1920, 1080);
              isFullSize = false;
            } else {
              // Switch to full size
              window.mirrorAPI.resizeMirrorWindow(1920, 1080);
              isFullSize = true;
            }
          }
        }
      <\/script>
    </body>
    </html>
  `)}`),u.once("ready-to-show",()=>{u.show(),u.center();try{u.setAspectRatio(q||1920/1080)}catch{}try{Q==null&&(Q=o.powerSaveBlocker.start("prevent-display-sleep")),u.webContents.setBackgroundThrottling(!1)}catch{}}),u.webContents.on("before-input-event",(t,e)=>{e.key==="Escape"&&u.close()}),u.on("closed",()=>{try{Q!=null&&o.powerSaveBlocker.stop(Q)}catch{}Q=null,console.log("Mirror window closed, notifying main app"),c&&!c.isDestroyed()&&c.webContents.send("mirror-window-closed"),u=null})}function Ge(){u&&!u.isDestroyed()&&(u.close(),u=null)}function Ke(s,r){const n=B.get(s);if(n&&!n.isDestroyed()){try{n.focus()}catch{}return n}const t=l.join(__dirname,"mirror-preload.js"),e=l.join(__dirname,"preload.js"),i=p.existsSync(t)?t:e,d=se(),f=d?o.nativeImage.createFromPath(d):void 0,m=new o.BrowserWindow({width:r?.width??960,height:r?.height??540,x:r?.x,y:r?.y,title:r?.title??`VJ Mirror Slice: ${s}`,icon:f,webPreferences:{nodeIntegration:!1,contextIsolation:!0,sandbox:!1,webSecurity:!1,allowRunningInsecureContent:!0,preload:i},show:!1,resizable:!0,maximizable:!0,fullscreen:!1,kiosk:!1,alwaysOnTop:!0,skipTaskbar:!1,focusable:!0,movable:!0,frame:!1,titleBarStyle:"hidden",transparent:!1,thickFrame:!1,hasShadow:!1,backgroundColor:"#000000",fullscreenable:!0,autoHideMenuBar:!0,minWidth:320,minHeight:180});try{m.setMenuBarVisibility(!1)}catch{}try{m.removeMenu()}catch{}const w=`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${r?.title??`VJ Mirror Slice: ${s}`}</title>
      <style>
        body {
          margin: 0;
          padding: 0;
          background: #000;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          overflow: hidden;
          font-family: monospace;
        }
        /* Make the background draggable */
        body::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          -webkit-app-region: drag;
          z-index: 0;
        }
        img { width: 100%; height: 100%; object-fit: cover; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; transition: opacity 0.1s ease-in-out; -webkit-app-region: drag; position: relative; z-index: 1; }
        #mirror-image { opacity: 0; transition: opacity 0.2s ease-in-out; }
        #mirror-image.loaded { opacity: 1; }
      </style>
    </head>
    <body ondblclick="toggleFullscreen()">
      <img id="mirror-image" style="display: none;" onload="this.classList.add('loaded');">
      <script>
        function toggleFullscreen() {
          try { window.advancedMirror && window.advancedMirror.toggleSliceFullscreen && window.advancedMirror.toggleSliceFullscreen('${s}'); } catch {}
        }
      <\/script>
    </body>
    </html>
  `;m.loadURL(`data:text/html,${encodeURIComponent(w)}`);try{m.show(),m.center()}catch{}return m.once("ready-to-show",()=>{try{m.isVisible()||(m.show(),m.center())}catch{}}),m.on("closed",()=>{B.delete(s)}),m.webContents.on("before-input-event",(O,_)=>{_.key==="Escape"&&m.close()}),B.set(s,m),m}function Ye(){const s=[{label:"VJ App",submenu:[{label:"About VJ App",role:"about"},{type:"separator"},{label:"Quit",accelerator:"CmdOrCtrl+Q",click:()=>{o.app.quit()}}]},{label:"External",submenu:[{label:"Mirror Window",accelerator:"CmdOrCtrl+M",click:()=>{c&&c.webContents.send("toggle-mirror")}},{label:"Advanced Mirror",accelerator:"CmdOrCtrl+Shift+M",click:()=>{c&&c.webContents.send("toggle-advanced-mirror")}},{type:"separator"},{label:"Spout Output",click:()=>{try{c?.webContents.send("spout:toggle")}catch{}}}]},{label:"Record",submenu:[{label:"Record",accelerator:"CmdOrCtrl+Shift+R",click:()=>{c&&c.webContents.send("record:start")}},{label:"Record Settings",click:()=>{c&&c.webContents.send("record:settings")}}]},{label:"View",submenu:[{label:"Toggle Mirror Window",accelerator:"CmdOrCtrl+M",click:()=>{c&&c.webContents.send("toggle-mirror")}},{type:"separator"},{label:"Reload",accelerator:"CmdOrCtrl+R",click:()=>{c&&c.reload()}}]},{label:"Developer",submenu:[{label:"Toggle Debug Overlay",accelerator:"CmdOrCtrl+Shift+D",click:()=>{try{c?.webContents.send("debug:toggleOverlay")}catch{}}},{label:"Show Debug Panel",accelerator:"CmdOrCtrl+Alt+D",click:()=>{try{c?.webContents.send("debug:openPanel")}catch{}}},{type:"separator"},{label:"Toggle Developer Tools",accelerator:"F12",click:()=>{c&&c.webContents.toggleDevTools()}}]},{label:"Window",submenu:[{label:"Minimize",accelerator:"CmdOrCtrl+M",role:"minimize"},{label:"Close",accelerator:"CmdOrCtrl+W",role:"close"}]}],r=o.Menu.buildFromTemplate(s);o.Menu.setApplicationMenu(r)}o.app.whenReady().then(()=>{console.log("Electron app is ready"),console.log("=== APP PATHS DEBUG ==="),console.log("app.getAppPath():",o.app.getPath("appData")),console.log("app.getPath(exe):",o.app.getPath("exe")),console.log("process.execPath:",process.execPath),console.log("process.resourcesPath:",process.resourcesPath);try{P=Ve({measurementId:process.env.GA4_MEASUREMENT_ID||"G-6F2FP4ZXNS",apiSecret:process.env.GA4_API_SECRET,appName:"Sonomika",enableInDev:String(process.env.GA4_ENABLE_DEV||"").toLowerCase()==="true"}),ne=Date.now(),de=ne,P.trackFirstOpenOnce(),P.trackAppOpen(),W=Date.now();const n=P;n&&n.enabled&&(te=setInterval(()=>{try{const t=Date.now(),e=Math.max(0,t-de);de=t;const i=pe(t);n.track("user_engagement",{ts_ms:t,uptime_ms:Math.max(0,t-ne),heartbeat_interval_ms:e,engagement_time_msec:Math.max(0,i),active_total_ms:re})}catch{}},6e4))}catch{}if(process.platform==="win32")try{o.app.setAppUserModelId("com.sonomika.app"),console.log("Set app user model ID for Windows taskbar icon")}catch(n){console.error("Error setting app user model ID:",n)}try{o.app.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required")}catch{}try{const n=se();console.log("Icon path resolved at app.whenReady():",n),process.platform==="darwin"&&n&&o.app.dock&&typeof o.app.dock.setIcon=="function"&&o.app.dock.setIcon(o.nativeImage.createFromPath(n))}catch(n){console.error("Error setting dock icon:",n)}o.app.commandLine.appendSwitch("disable-background-timer-throttling"),o.app.commandLine.appendSwitch("disable-renderer-backgrounding"),o.app.commandLine.appendSwitch("disable-backgrounding-occluded-windows");try{const n=o.app.commandLine.getSwitchValue("disable-features"),t="CalculateNativeWinOcclusion";n&&n.length>0?n.split(",").includes(t)||o.app.commandLine.appendSwitch("disable-features",`${n},${t}`):o.app.commandLine.appendSwitch("disable-features",t)}catch{}Ye(),Ue(),qe(),o.protocol.registerFileProtocol("local-file",(n,t)=>{const e=n.url.replace("local-file://","");console.log("Loading local file:",e),console.log("Request URL:",n.url),console.log("File path resolved:",e),t(e)}),o.ipcMain.on("ga4:track",(n,t)=>{try{if(!P?.enabled)return;const e=String(t?.name||"").trim();if(!e)return;const i=e.slice(0,40).replace(/[^a-zA-Z0-9_]/g,"_"),d=t?.params&&typeof t.params=="object"?t.params:{},f={};for(const[m,w]of Object.entries(d)){const O=String(m||"").trim().slice(0,40).replace(/[^a-zA-Z0-9_]/g,"_");if(!O||w==null)continue;const _=typeof w;if(_==="string"){const N=String(w);f[O]=N.length>120?N.slice(0,120):N}else if(_==="number"){const N=Number(w);isFinite(N)&&(f[O]=N)}else _==="boolean"&&(f[O]=!!w)}P.track(i,f)}catch{}}),o.ipcMain.handle("show-open-dialog",async(n,t)=>await o.dialog.showOpenDialog(c,t)),o.ipcMain.handle("show-save-dialog",async(n,t)=>{console.log("Show save dialog called with options:",t);const e=await o.dialog.showSaveDialog(c,t);return console.log("Save dialog result:",e),e}),o.ipcMain.handle("save-file",async(n,t,e)=>{try{return await p.promises.writeFile(t,e,"utf8"),!0}catch(i){return console.error("Failed to save file:",i),!1}}),o.ipcMain.handle("save-binary-file",async(n,t,e)=>{try{return console.log("Saving binary file to:",t,"Size:",e.length,"bytes"),await p.promises.writeFile(t,Buffer.from(e)),console.log("Binary file saved successfully"),!0}catch(i){return console.error("Failed to save binary file:",i),!1}});let s=null,r=null;o.ipcMain.handle("offline-render:start",async(n,t)=>{try{const e=l.join(o.app.getPath("userData"),"offline-renders"),i=l.join(e,`${Date.now()}_${(t?.name||"movie").replace(/[^a-z0-9_-]/ig,"_")}`);return await p.promises.mkdir(i,{recursive:!0}),s={dir:i,name:String(t?.name||"movie"),fps:Number(t?.fps)||0,index:0,width:Number(t?.width)||1920,height:Number(t?.height)||1080,quality:t?.quality||"medium"},r=null,console.log("[offline] start",{dir:i,fps:s.fps||"preview",quality:s.quality,size:`${s.width}x${s.height}`}),{success:!0,dir:i}}catch(e){return console.error("[offline] start error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("offline-render:frame",async(n,t)=>{if(!s)return{success:!1,error:"No session"};try{const e=s,i=l.join(e.dir,`frame_${String(e.index).padStart(6,"0")}.png`),d=String(t?.dataUrl||"").replace(/^data:image\/png;base64,/,"");return await p.promises.writeFile(i,Buffer.from(d,"base64")),e.index+=1,e.index%60===0&&console.log("[offline] saved frames:",e.index),{success:!0,index:e.index}}catch(e){return console.error("[offline] frame error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("offline-render:finish",async(n,t)=>{if(!s)return{success:!1,error:"No session"};s=null;try{return{success:!1,error:"Offline rendering is disabled. Please use WebM recording via MediaRecorder instead."}}catch(e){return console.error("[offline] finish error",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("get-system-audio-stream",async()=>{try{const{desktopCapturer:n}=require("electron"),t=await n.getSources({types:["screen"],thumbnailSize:{width:1,height:1}});if(t.length===0)throw new Error("No screen sources available");return{success:!0,sourceId:(t.find(i=>i.name==="Entire Screen")||t[0]).id}}catch(n){return console.error("Failed to get system audio stream:",n),{success:!1,error:String(n)}}}),o.ipcMain.handle("get-documents-folder",async()=>{try{const n=o.app.getPath("documents");return{success:!0,path:l.join(n,"Sonomika")}}catch(n){return console.error("Failed to get Documents folder:",n),{success:!1,error:String(n)}}}),o.ipcMain.handle("get-app-path",async()=>o.app.getAppPath()),o.ipcMain.handle("open-external-url",async(n,t)=>{try{return t&&typeof t=="string"&&(t.startsWith("http://")||t.startsWith("https://"))?(await o.shell.openExternal(t),{success:!0}):{success:!1,error:"Invalid URL"}}catch(e){return console.error("open-external-url failed:",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("get-app-version",async()=>{try{const n=e=>{try{if(!e||!p.existsSync(e))return"";const i=p.readFileSync(e,"utf8"),f=JSON.parse(i)?.version;return typeof f=="string"?f.trim():""}catch{return""}},t=[l.join(o.app.getAppPath(),"package.json"),l.join(process.cwd(),"package.json"),l.resolve(__dirname,"..","..","package.json"),l.resolve(__dirname,"..","package.json")];for(const e of t){const i=n(e);if(i)return i}return o.app.getVersion()}catch(n){return console.error("Failed to get app version:",n),"unknown"}}),o.ipcMain.handle("get-resources-path",async()=>process.resourcesPath||o.app.getAppPath()),o.ipcMain.handle("spout:start",async(n,t)=>{try{const e=Y.start(be);return e.ok===!1?(console.warn("[spout] start failed:",e.error),{success:!1,error:e.error}):(console.log("[spout] started sender:",be),{success:!0})}catch(e){return console.warn("[spout] start exception:",e),{success:!1,error:String(e)}}}),o.ipcMain.handle("spout:stop",async()=>{try{Y.stop();try{setTimeout(()=>{try{Y.stop()}catch{}},200)}catch{}return console.log("[spout] stopped"),{success:!0}}catch(n){return console.warn("[spout] stop exception:",n),{success:!1,error:String(n)}}}),o.ipcMain.on("spout:frame",(n,t)=>{try{if(!Y.isRunning())return;Y.pushDataUrlFrame(String(t?.dataUrl||""),{maxFps:Le})}catch{}}),o.ipcMain.handle("read-file-text",async(n,t)=>{try{return await p.promises.readFile(t,"utf8")}catch(e){return console.error("Failed to read file:",e),null}}),o.ipcMain.handle("read-local-file-base64",async(n,t)=>{try{return(await p.promises.readFile(t)).toString("base64")}catch(e){throw console.error("Failed to read local file:",t,e),e}}),o.ipcMain.handle("read-audio-bytes",async(n,t)=>{try{const{fileURLToPath:e}=require("url"),i=typeof t=="string"&&t.startsWith("file:")?e(t):t,d=await p.promises.readFile(i);return d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength)}catch(e){return console.error("read-audio-bytes failed for",t,e),new ArrayBuffer(0)}}),o.ipcMain.handle("authStorage:isEncryptionAvailable",()=>{try{return o.safeStorage.isEncryptionAvailable()}catch{return!1}}),o.ipcMain.on("authStorage:isEncryptionAvailableSync",n=>{try{n.returnValue=o.safeStorage.isEncryptionAvailable()}catch{n.returnValue=!1}}),o.ipcMain.handle("authStorage:save",async(n,t,e)=>{try{return t?e==null||e===""?(delete A[t],K(),!0):(o.safeStorage.isEncryptionAvailable()?A[t]=o.safeStorage.encryptString(e):A[t]=Buffer.from(e,"utf8"),K(),!0):!1}catch(i){return console.error("Failed to save auth blob:",i),!1}}),o.ipcMain.on("authStorage:saveSync",(n,t,e)=>{try{if(!t){n.returnValue=!1;return}if(e==null||e===""){delete A[t],K(),n.returnValue=!0;return}o.safeStorage.isEncryptionAvailable()?A[t]=o.safeStorage.encryptString(e):A[t]=Buffer.from(e,"utf8"),K(),n.returnValue=!0}catch(i){console.error("Failed to save auth blob (sync):",i),n.returnValue=!1}}),o.ipcMain.handle("authStorage:load",async(n,t)=>{try{if(!t)return null;const e=A[t];return e?o.safeStorage.isEncryptionAvailable()?o.safeStorage.decryptString(e):e.toString("utf8"):null}catch(e){return console.error("Failed to load auth blob:",e),null}}),o.ipcMain.on("authStorage:loadSync",(n,t)=>{try{if(!t){n.returnValue=null;return}const e=A[t];if(!e){n.returnValue=null;return}o.safeStorage.isEncryptionAvailable()?n.returnValue=o.safeStorage.decryptString(e):n.returnValue=e.toString("utf8")}catch(e){console.error("Failed to load auth blob (sync):",e),n.returnValue=null}}),o.ipcMain.handle("authStorage:remove",async(n,t)=>{try{return t?(delete A[t],K(),!0):!1}catch(e){return console.error("Failed to remove auth blob:",e),!1}}),o.ipcMain.on("authStorage:removeSync",(n,t)=>{try{if(!t){n.returnValue=!1;return}delete A[t],K(),n.returnValue=!0}catch(e){console.error("Failed to remove auth blob (sync):",e),n.returnValue=!1}}),o.ipcMain.handle("authStorage:loadAll",async()=>{try{const n={};for(const[t,e]of Object.entries(A))try{o.safeStorage.isEncryptionAvailable()?n[t]=o.safeStorage.decryptString(e):n[t]=e.toString("utf8")}catch{}return n}catch(n){return console.error("Failed to loadAll auth blobs:",n),{}}}),o.ipcMain.handle("get-screen-sizes",async()=>{try{const{screen:n}=require("electron"),t=n.getAllDisplays();console.log("Electron main: Detected displays:",t.length),t.forEach((i,d)=>{console.log(`Display ${d+1}:`,{width:i.bounds.width,height:i.bounds.height,x:i.bounds.x,y:i.bounds.y,scaleFactor:i.scaleFactor,rotation:i.rotation,label:i.label})});const e=t.map(i=>({width:i.bounds.width,height:i.bounds.height}));return console.log("Electron main: Returning screen sizes:",e),e}catch(n){return console.error("Failed to get screen sizes:",n),[]}}),o.ipcMain.on("toggle-app-fullscreen",()=>{if(c&&!c.isDestroyed()){const{screen:n}=require("electron");if(c.isKiosk()||c.isFullScreen())c.setKiosk(!1),c.setFullScreen(!1),c.setBounds({width:1200,height:800}),c.center();else{const t=c.getBounds(),e=n.getDisplayMatching(t);c.setBounds({x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height}),c.setMenuBarVisibility(!1),c.setFullScreenable(!0),c.setAlwaysOnTop(!0),c.setKiosk(!0),c.setFullScreen(!0)}}}),o.ipcMain.on("window-minimize",()=>{console.log("Main: window-minimize IPC received"),c?(console.log("Main: calling mainWindow.minimize()"),c.minimize()):console.log("Main: mainWindow is null")}),o.ipcMain.on("window-maximize",()=>{if(console.log("Main: window-maximize IPC received"),c)if(c.isMaximized()){console.log("Main: calling mainWindow.unmaximize()"),c.unmaximize();try{c.webContents.send("window-state",{maximized:!1})}catch{}}else{console.log("Main: calling mainWindow.maximize()"),c.maximize();try{c.webContents.send("window-state",{maximized:!0})}catch{}}else console.log("Main: mainWindow is null")}),o.ipcMain.on("window-close",()=>{console.log("Main: window-close IPC received"),c?(console.log("Main: calling mainWindow.close()"),c.close()):console.log("Main: mainWindow is null")}),o.ipcMain.on("toggle-mirror",()=>{c&&c.webContents.send("toggle-mirror")}),o.ipcMain.on("open-mirror-window",()=>{We()}),o.ipcMain.on("close-mirror-window",()=>{Ge()}),o.ipcMain.on("set-mirror-bg",(n,t)=>{if(u&&!u.isDestroyed()){const e=typeof t=="string"?t.replace(/'/g,"\\'"):"#000000";u.webContents.executeJavaScript(`document.body.style.background='${e}'`)}}),o.ipcMain.on("canvas-data",(n,t)=>{u&&!u.isDestroyed()&&u.webContents.send("update-canvas",t)}),o.ipcMain.on("sendCanvasData",(n,t)=>{if(u&&!u.isDestroyed())try{const e=(typeof t=="string"?t:"").replace(/'/g,"\\'");u.webContents.executeJavaScript(`
          (function(){
            try {
              var noStream = document.getElementById('no-stream');
              var img = document.getElementById('mirror-image');
              if (noStream) noStream.style.display = 'none';
              if (img) {
                if (img.src !== '${e}') {
                  img.src = '${e}';
                  img.style.display = 'block';
                }
              }
            } catch(e) {}
          })();
        `)}catch{}}),o.ipcMain.on("toggle-fullscreen",()=>{if(u&&!u.isDestroyed()){const{screen:n}=require("electron");if(u.isKiosk()||u.isFullScreen()){u.setKiosk(!1),u.setFullScreen(!1);try{u.setVisibleOnAllWorkspaces(!1)}catch{}try{u.setAlwaysOnTop(!0)}catch{}u.setBounds({x:void 0,y:void 0,width:1920,height:1080});try{u.center()}catch{}try{u.focus()}catch{}}else{const t=u.getBounds(),e=n.getDisplayMatching(t);u.setBounds({x:e.bounds.x,y:e.bounds.y,width:e.bounds.width,height:e.bounds.height});try{u.setMenuBarVisibility(!1)}catch{}try{u.setFullScreenable(!0)}catch{}try{process.platform==="darwin"?u.setAlwaysOnTop(!0,"screen-saver"):u.setAlwaysOnTop(!0)}catch{}try{u.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}try{u.moveTop?.()}catch{}try{u.show()}catch{}try{u.focus()}catch{}u.setKiosk(!0),u.setFullScreen(!0);try{u.moveTop?.()}catch{}try{u.focus()}catch{}}}}),o.ipcMain.on("resize-mirror-window",(n,t,e)=>{if(u&&!u.isDestroyed()){try{let i=Math.max(1,Number(t)||1),d=Math.max(1,Number(e)||1);const{screen:f}=require("electron"),w=f.getPrimaryDisplay().workArea,O=Math.floor(w.width*.9),_=Math.floor(w.height*.9),N=i/d;if(i>O||d>_){const V=O/i,C=_/d,M=Math.min(V,C);i=Math.floor(i*M),d=Math.floor(d*M)}i=Math.max(480,i),d=Math.max(270,d),q&&isFinite(q)&&q>0&&(d=Math.max(1,Math.round(i/q))),console.log("Resizing mirror window to:",i,"x",d,"(aspect locked:",!!q,")"),u.setSize(i,d)}catch{}u.center()}}),o.ipcMain.on("set-mirror-aspect",(n,t,e)=>{try{const i=Math.max(1,Number(t)||1),d=Math.max(1,Number(e)||1),f=i/d;if(q=f,X=f,u&&!u.isDestroyed())try{u.setAspectRatio(f)}catch{}if(Z&&!Z.isDestroyed())try{Z.setAspectRatio(f)}catch{}}catch{}}),o.ipcMain.on("advanced-mirror:open",(n,t)=>{try{if(console.log("[main] advanced-mirror:open",Array.isArray(t)?t.map(e=>e?.id):t),Array.isArray(t))for(const e of t)console.log("[main] createAdvancedMirrorWindow",e?.id),Ke(String(e.id),e)}catch(e){console.warn("advanced-mirror:open error",e)}}),o.ipcMain.on("advanced-mirror:closeAll",()=>{try{B.forEach((n,t)=>{try{n.isDestroyed()||n.close()}catch{}B.delete(t)})}catch(n){console.warn("advanced-mirror:closeAll error",n)}}),o.ipcMain.on("advanced-mirror:sendSliceData",(n,t,e)=>{const i=B.get(String(t));if(i&&!i.isDestroyed()){const d=(typeof e=="string"?e:"").replace(/'/g,"\\'");i.webContents.executeJavaScript(`
        (function() {
          const mirrorImage = document.getElementById('mirror-image');
          if (mirrorImage) {
            if (mirrorImage.src !== '${d}') {
              mirrorImage.src = '${d}';
              mirrorImage.style.display = 'block';
            }
          }
        })();
      `)}}),o.ipcMain.on("advanced-mirror:setBg",(n,t,e)=>{const i=B.get(String(t));if(i&&!i.isDestroyed()){const d=typeof e=="string"?e.replace(/'/g,"\\'"):"#000000";i.webContents.executeJavaScript(`document.body.style.background='${d}'`)}}),o.ipcMain.on("advanced-mirror:resize",(n,t,e,i)=>{const d=B.get(String(t));if(d&&!d.isDestroyed())try{d.setSize(e,i),d.center()}catch{}}),o.ipcMain.on("advanced-mirror:toggleFullscreen",(n,t)=>{const e=B.get(String(t));if(e&&!e.isDestroyed()){const{screen:i}=require("electron");if(e.isKiosk()||e.isFullScreen())try{e.setKiosk(!1),e.setFullScreen(!1),e.setBounds({width:960,height:540}),e.center()}catch{}else try{const d=e.getBounds(),f=i.getDisplayMatching(d);e.setBounds({x:f.bounds.x,y:f.bounds.y,width:f.bounds.width,height:f.bounds.height}),e.setMenuBarVisibility(!1),e.setFullScreenable(!0),e.setAlwaysOnTop(!0),e.setKiosk(!0),e.setFullScreen(!0)}catch{}}}),ve(),o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&ve()})});try{o.app.on("before-quit",()=>{try{const s=Date.now(),r=pe(s);W=null;try{te&&clearInterval(te)}catch{}te=null,P?.track("session_end",{ts_ms:s,uptime_ms:Math.max(0,s-ne),active_delta_ms:r,active_total_ms:re}),P?.track("app_quit",{ts_ms:s})}catch{}try{Y.stop()}catch{}})}catch{}o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&o.app.quit()});process.on("uncaughtException",s=>{console.error("Uncaught Exception:",s);try{P?.trackAppError(s?.name||"uncaughtException")}catch{}});process.on("unhandledRejection",(s,r)=>{console.error("Unhandled Rejection at:",r,"reason:",s);try{P?.trackAppError("unhandledRejection")}catch{}});
